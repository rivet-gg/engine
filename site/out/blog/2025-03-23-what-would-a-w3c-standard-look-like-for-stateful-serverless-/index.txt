1:"$Sreact.fragment"
2:I[65327,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","8229","static/chunks/9da6db1e-dbfab9261a7c6a02.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","3285","static/chunks/3285-d8e61078321bd50f.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3459","static/chunks/3459-aa0b1d8277b7bbbd.js","7177","static/chunks/app/layout-e3cfc449b871f8f6.js"],"GoogleAnalytics"]
3:I[559,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","8229","static/chunks/9da6db1e-dbfab9261a7c6a02.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","3285","static/chunks/3285-d8e61078321bd50f.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3459","static/chunks/3459-aa0b1d8277b7bbbd.js","7177","static/chunks/app/layout-e3cfc449b871f8f6.js"],""]
4:I[32761,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"TooltipProvider"]
5:I[79838,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","8229","static/chunks/9da6db1e-dbfab9261a7c6a02.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","3285","static/chunks/3285-d8e61078321bd50f.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3459","static/chunks/3459-aa0b1d8277b7bbbd.js","7177","static/chunks/app/layout-e3cfc449b871f8f6.js"],"Providers"]
6:I[49287,[],""]
7:I[34235,[],""]
8:I[91971,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"Toaster"]
9:I[82345,["7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","3591","static/chunks/3591-193e430a542376f5.js","4395","static/chunks/4395-09a8f40ef66f9d5c.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7261","static/chunks/7261-eddb3e7984c54a8d.js","5212","static/chunks/app/(v2)/(blog)/blog/layout-04840f1e5a481f10.js"],"Header"]
a:I[59534,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],""]
b:"$Sreact.suspense"
c:I[82813,["7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","3459","static/chunks/3459-aa0b1d8277b7bbbd.js","5519","static/chunks/app/(v2)/layout-24f9ee0b53a6742c.js"],"EmbedDetector"]
d:I[53696,["7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","3459","static/chunks/3459-aa0b1d8277b7bbbd.js","5519","static/chunks/app/(v2)/layout-24f9ee0b53a6742c.js"],"Footer"]
f:I[93621,[],"MetadataBoundary"]
11:I[93621,[],"OutletBoundary"]
14:I[16867,[],"AsyncMetadataOutlet"]
16:I[93621,[],"ViewportBoundary"]
18:I[27890,[],""]
:HL["/_next/static/css/565f4925fe90494c.css","style"]
:HL["/_next/static/css/b2a053553e69c47d.css","style"]
:HL["/_next/static/css/9ded352fd1582faa.css","style"]
0:{"P":null,"b":"xyrr8R3WCFgaolPiXJ-Nn","p":"","c":["","blog","2025-03-23-what-would-a-w3c-standard-look-like-for-stateful-serverless-",""],"i":false,"f":[[["",{"children":["(v2)",{"children":["(blog)",{"children":["blog",{"children":[["slug","2025-03-23-what-would-a-w3c-standard-look-like-for-stateful-serverless-","c"],{"children":["__PAGE__",{}]}]}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/565f4925fe90494c.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","className":"dark","children":[["$","head",null,{"children":[["$","$L2",null,{"gaId":"G-GHX1328ZFD"}],["$","$L3",null,{"src":"https://analytics.ahrefs.com/analytics.js","data-key":"wQAsHie9RgJMLNhmUbr/fQ","strategy":"beforeInteractive"}],["$","link",null,{"rel":"apple-touch-icon","sizes":"180x180","href":"/icons/apple-touch-icon.png?20240925"}],["$","link",null,{"rel":"icon","type":"image/png","sizes":"32x32","href":"/icons/favicon-32x32.png?20240925"}],["$","link",null,{"rel":"icon","type":"image/png","sizes":"16x16","href":"/icons/favicon-16x16.png?20240925"}],["$","link",null,{"rel":"manifest","href":"/icons/site.webmanifest?20240925"}],["$","link",null,{"rel":"mask-icon","href":"/icons/safari-pinned-tab.svg?20240925","color":"#5bbad5"}],["$","meta",null,{"name":"msapplication-TileColor","content":"#0c0a09"}],["$","meta",null,{"name":"theme-color","content":"#0c0a09"}],["$","meta",null,{"name":"viewport","content":"width=device-width, initial-scale=1.0"}]]}],["$","body",null,{"className":"dark","children":[["$","$L4",null,{"children":["$","$L5",null,{"children":["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]}],["$","$L8",null,{"theme":"system","className":"toaster group right-8","toastOptions":{"classNames":{"toast":"group toast group-[.toaster]:bg-card group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg group-[.toaster]:border group-[.toaster]:rounded-md","description":"group-[.toast]:text-muted-foreground","actionButton":"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground","cancelButton":"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}}}]]}]]}]]}],{"children":["(v2)",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/b2a053553e69c47d.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/_next/static/css/9ded352fd1582faa.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],[["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[["$","$L9",null,{"variant":"floating"}],["$","div",null,{"className":"relative flex min-h-[80vh] w-full items-center justify-center text-center","children":["$","div",null,{"className":"transition-opacity","children":[["$","h1",null,{"className":"mb-3 flex items-center justify-center text-3xl text-white","children":[["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"block-question","className":"svg-inline--fa fa-block-question mr-2 size-10","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64L64 32zm73.8 149.3c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L248 280.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM192 368a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zM48 104a24 24 0 1 1 48 0 24 24 0 1 1 -48 0zM376 80a24 24 0 1 1 0 48 24 24 0 1 1 0-48zM48 408a24 24 0 1 1 48 0 24 24 0 1 1 -48 0zm328-24a24 24 0 1 1 0 48 24 24 0 1 1 0-48z","style":{}}]}]," ","Not Found"]}],["$","$La",null,{"aria-selected":false,"className":"relative inline-flex items-center justify-center gap-0.5 overflow-hidden font-semibold transition inline-flex items-center justify-center gap-0.5 rounded-sm px-3 py-1 text-sm font-semibold bg-transparent text-cream-100 border-2 border-cream-100 hover:bg-cream-100 hover:text-charcole-950","href":"/","children":[null,false,"Home",false]}]]}]}]],[]],"forbidden":"$undefined","unauthorized":"$undefined"}],["$","$b",null,{"children":["$","$Lc",null,{}]}],["$","$Ld",null,{}]]]}],{"children":["(blog)",["$","$1","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["blog",["$","$1","c",{"children":[null,[["$","$L9",null,{"active":"blog","variant":"floating"}],["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]]}],{"children":[["slug","2025-03-23-what-would-a-w3c-standard-look-like-for-stateful-serverless-","c"],["$","$1","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$Le",["$","$Lf",null,{"children":"$L10"}],null,["$","$L11",null,{"children":["$L12","$L13",["$","$L14",null,{"promise":"$@15"}]]}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","7Y9NwDdW14hjwOe-JLdnH",{"children":[["$","$L16",null,{"children":"$L17"}],null]}],null]}],false]],"m":"$undefined","G":["$18","$undefined"],"s":false,"S":true}
19:I[16867,[],"AsyncMetadata"]
10:["$","$b",null,{"fallback":null,"children":["$","$L19",null,{"promise":"$@1a"}]}]
13:null
1b:I[1143,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"Avatar"]
1c:I[1143,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"AvatarFallback"]
1d:I[1143,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"AvatarImage"]
20:I[63571,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"Image"]
21:I[75036,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"Heading"]
22:I[32761,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"WithTooltip"]
23:I[30860,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"CopyCodeTrigger"]
24:I[63843,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"ScrollArea"]
2b:I[48652,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"Tabs"]
2c:I[48652,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"TabsList"]
2d:I[48652,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"TabsTrigger"]
2e:I[48652,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","35","static/chunks/app/(v2)/(blog)/blog/page-6e2380a8fbf5f3da.js"],"TabsContent"]
47:I[49720,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","8229","static/chunks/9da6db1e-dbfab9261a7c6a02.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","3733","static/chunks/3733-74f52baf8b8f8b32.js","5081","static/chunks/app/(v2)/(blog)/blog/%5B...slug%5D/page-dd20a2b305eff2bd.js"],"ArticleSocials"]
48:I[9777,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","8229","static/chunks/9da6db1e-dbfab9261a7c6a02.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","3733","static/chunks/3733-74f52baf8b8f8b32.js","5081","static/chunks/app/(v2)/(blog)/blog/%5B...slug%5D/page-dd20a2b305eff2bd.js"],"DocsTableOfContents"]
49:I[19897,["1965","static/chunks/f67032f2-9c72234b0d8f41b4.js","8229","static/chunks/9da6db1e-dbfab9261a7c6a02.js","7134","static/chunks/7134-7a2ccc87dc1f1c96.js","9078","static/chunks/9078-9c4b2ff48765f274.js","6855","static/chunks/6855-c97c866fb9680afe.js","5051","static/chunks/5051-51ff92d736937f41.js","9657","static/chunks/9657-90d7d8e86cd8d7b3.js","1983","static/chunks/1983-7439545cf8f39348.js","7678","static/chunks/7678-80db3db210142fa5.js","3545","static/chunks/3545-9e4a648ea2701538.js","3733","static/chunks/3733-74f52baf8b8f8b32.js","5081","static/chunks/app/(v2)/(blog)/blog/%5B...slug%5D/page-dd20a2b305eff2bd.js"],"Comments"]
1e:T518,M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z25:T10bf,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Once created, this DurableObject will exist indefinitely</span></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> class</span><span style="color:#59C2FF"> Counter</span><span style="color:#FF8F40"> extends</span><span style="color:#39BAE6"> DurableObject</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">  count</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> number</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">  constructor</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">state</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> env</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    super</span><span style="color:#BFBDB6">(state</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> env)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    this</span><span style="color:#F29668">.</span><span style="color:#FFB454">setup</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">  async</span><span style="color:#FFB454"> setup</span><span style="color:#BFBDB6">() {</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">count </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> state</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">||</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFB454">  increment</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">count</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> number</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Update state</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">count </span><span style="color:#F29668">+=</span><span style="color:#D2A6FF"> 1</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Persist state</span></span>
<span class="line"><span style="color:#FF8F40">    await</span><span style="color:#39BAE6;font-style:italic"> this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">ctx</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6B3">,</span><span style="color:#39BAE6;font-style:italic"> this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">count)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">    return</span><span style="color:#39BAE6;font-style:italic"> this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">count</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>26:Te5d,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> class</span><span style="color:#59C2FF"> Counter</span><span style="color:#FF8F40"> extends</span><span style="color:#39BAE6"> DurableObject</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  constructor</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">state</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> env</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    super</span><span style="color:#BFBDB6">(state</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> env)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    this</span><span style="color:#F29668">.</span><span style="color:#FFB454">setup</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">  async</span><span style="color:#FFB454"> setup</span><span style="color:#BFBDB6">() {</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">count </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> state</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">||</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFB454">  increment</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">count</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> number</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">count </span><span style="color:#F29668">+=</span><span style="color:#D2A6FF"> 1</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    await</span><span style="color:#39BAE6;font-style:italic"> this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">ctx</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6B3">,</span><span style="color:#39BAE6;font-style:italic"> this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">count)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    return</span><span style="color:#39BAE6;font-style:italic"> this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">count</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>27:T1494,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">import</span><span style="color:#FF8F40"> type</span><span style="color:#BFBDB6"> { ActorContext } </span><span style="color:#FF8F40">from</span><span style="color:#AAD94C"> "@rivet-gg/actor"</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">import</span><span style="color:#D2A6FF"> *</span><span style="color:#FF8F40"> as</span><span style="color:#BFBDB6"> http </span><span style="color:#FF8F40">from</span><span style="color:#AAD94C"> "http"</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  async</span><span style="color:#FFB454"> start</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">ctx</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> ActorContext</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    let</span><span style="color:#BFBDB6"> count </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> ctx</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">kv</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">||</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> server </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> http</span><span style="color:#F29668">.</span><span style="color:#FFB454">createServer</span><span style="color:#BFBDB6">((</span><span style="color:#D2A6FF">req</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> res</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      count </span><span style="color:#F29668">+=</span><span style="color:#D2A6FF"> 1</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">      await</span><span style="color:#BFBDB6"> ctx</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">kv</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> count)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BFBDB6">      res</span><span style="color:#F29668">.</span><span style="color:#FFB454">writeHead</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">200</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> { </span><span style="color:#AAD94C">"Content-Type"</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "text/plain"</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      res</span><span style="color:#F29668">.</span><span style="color:#FFB454">end</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">`Count: </span><span style="color:#FF8F40">${</span><span style="color:#39BAE6;font-style:italic">this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">count</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    server</span><span style="color:#F29668">.</span><span style="color:#FFB454">listen</span><span style="color:#BFBDB6">(process</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">env</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">PORT_HTTP)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Keep the actor running until explicitly destroyed</span></span>
<span class="line"><span style="color:#FF8F40">    await</span><span style="color:#F29668"> new</span><span style="color:#39BAE6"> Promise</span><span style="color:#BFBDB6">((</span><span style="color:#D2A6FF">resolve</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {})</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>28:Te50,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">import</span><span style="color:#BFBDB6"> { actor } </span><span style="color:#FF8F40">from</span><span style="color:#AAD94C"> "@rivetkit/actor"</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> chatRoom </span><span style="color:#F29668">=</span><span style="color:#FFB454"> actor</span><span style="color:#BFBDB6">({</span></span>
<span class="line"><span style="color:#BFBDB6">  state</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> { messages</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> [] }</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">  actions</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // receive an action call from the client</span></span>
<span class="line"><span style="color:#FFB454">    sendMessage</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">c</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> username</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> message</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // save message to persistent storage</span></span>
<span class="line"><span style="color:#BFBDB6">      c</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">state</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">messages</span><span style="color:#F29668">.</span><span style="color:#FFB454">push</span><span style="color:#BFBDB6">({ username</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> message })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // broadcast message to all clients</span></span>
<span class="line"><span style="color:#BFBDB6">      c</span><span style="color:#F29668">.</span><span style="color:#FFB454">broadcast</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"newMessage"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> username</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> message)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // allow client to request message history</span></span>
<span class="line"><span style="color:#FFB454">    getMessages</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">c</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> c</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">state</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">messages</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">})</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>29:T1529,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> interface</span><span style="color:#59C2FF"> ActorDriver</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">	kvGet</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">actorId</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> key</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> KvKey</span><span style="color:#BFBDB6">)</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">KvValue</span><span style="color:#F29668"> |</span><span style="color:#39BAE6"> undefined</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">	kvGetBatch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">actorId</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> key</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> KvKey</span><span style="color:#BFBDB6">[])</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;(</span><span style="color:#59C2FF">KvValue</span><span style="color:#F29668"> |</span><span style="color:#39BAE6"> undefined</span><span style="color:#BFBDB6">)[]></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">	kvPut</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">actorId</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> key</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> KvKey</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> value</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> KvValue</span><span style="color:#BFBDB6">)</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#39BAE6">void</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">	kvPutBatch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">actorId</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> key</span><span style="color:#F29668">:</span><span style="color:#BFBDB6"> [</span><span style="color:#59C2FF">KvKey</span><span style="color:#BFBDB6B3">,</span><span style="color:#59C2FF"> KvValue</span><span style="color:#BFBDB6">][])</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#39BAE6">void</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">	kvDelete</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">actorId</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> key</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> KvKey</span><span style="color:#BFBDB6">)</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#39BAE6">void</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">	kvDeleteBatch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">actorId</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> key</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> KvKey</span><span style="color:#BFBDB6">[])</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#39BAE6">void</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">	setAlarm</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">actor</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> AnyActorInstance</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> timestamp</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> number</span><span style="color:#BFBDB6">)</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#39BAE6">void</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>2a:T1fb2,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> interface</span><span style="color:#59C2FF"> ManagerDriver</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">	getForId</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">input</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> GetForIdInput</span><span style="color:#BFBDB6">)</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">GetActorOutput</span><span style="color:#F29668"> |</span><span style="color:#39BAE6"> undefined</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">	getWithTags</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">input</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> GetWithTagsInput</span><span style="color:#BFBDB6">)</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">GetActorOutput</span><span style="color:#F29668"> |</span><span style="color:#39BAE6"> undefined</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">	createActor</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">input</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> CreateActorInput</span><span style="color:#BFBDB6">)</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> Promise</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">CreateActorOutput</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> interface</span><span style="color:#59C2FF"> GetForIdInput</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">E</span><span style="color:#FF8F40"> extends</span><span style="color:#59C2FF"> Env</span><span style="color:#F29668"> =</span><span style="color:#39BAE6"> any</span><span style="color:#BFBDB6">> {</span></span>
<span class="line"><span style="color:#BFBDB6">	c</span><span style="color:#F29668">?:</span><span style="color:#59C2FF"> HonoContext</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">E</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	baseUrl</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	actorId</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> interface</span><span style="color:#59C2FF"> GetWithTagsInput</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">E</span><span style="color:#FF8F40"> extends</span><span style="color:#59C2FF"> Env</span><span style="color:#F29668"> =</span><span style="color:#39BAE6"> any</span><span style="color:#BFBDB6">> {</span></span>
<span class="line"><span style="color:#BFBDB6">	c</span><span style="color:#F29668">?:</span><span style="color:#59C2FF"> HonoContext</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">E</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	baseUrl</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	name</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	tags</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> ActorTags</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> interface</span><span style="color:#59C2FF"> GetActorOutput</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">E</span><span style="color:#FF8F40"> extends</span><span style="color:#59C2FF"> Env</span><span style="color:#F29668"> =</span><span style="color:#39BAE6"> any</span><span style="color:#BFBDB6">> {</span></span>
<span class="line"><span style="color:#BFBDB6">	c</span><span style="color:#F29668">?:</span><span style="color:#59C2FF"> HonoContext</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">E</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	endpoint</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	name</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	tags</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> ActorTags</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> interface</span><span style="color:#59C2FF"> CreateActorInput</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">E</span><span style="color:#FF8F40"> extends</span><span style="color:#59C2FF"> Env</span><span style="color:#F29668"> =</span><span style="color:#39BAE6"> any</span><span style="color:#BFBDB6">> {</span></span>
<span class="line"><span style="color:#BFBDB6">	c</span><span style="color:#F29668">?:</span><span style="color:#59C2FF"> HonoContext</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">E</span><span style="color:#BFBDB6">></span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	baseUrl</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	name</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	tags</span><span style="color:#F29668">:</span><span style="color:#59C2FF"> ActorTags</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	region</span><span style="color:#F29668">?:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> interface</span><span style="color:#59C2FF"> CreateActorOutput</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">	endpoint</span><span style="color:#F29668">:</span><span style="color:#39BAE6"> string</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>2f:Te31,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// main.js - Browser</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> worker </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Worker</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'worker.js'</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">worker</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">({ type</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> 'INCREMENT'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> value</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 5</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">worker</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> event</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'Counter:'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// worker.js - Worker</span></span>
<span class="line"><span style="color:#FF8F40">let</span><span style="color:#BFBDB6"> counter </span><span style="color:#F29668">=</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">self</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> event</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  const</span><span style="color:#BFBDB6"> { type</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> value } </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">  if</span><span style="color:#BFBDB6"> (type </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> 'INCREMENT'</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">    counter </span><span style="color:#F29668">+=</span><span style="color:#BFBDB6"> value</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    self</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">(counter)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>30:T1cc9,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// server.js - Fetch handler</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> id </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> env</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">COUNTER</span><span style="color:#F29668">.</span><span style="color:#FFB454">idFromName</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'counter-1'</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> stub </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> env</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">COUNTER</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(id)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> response </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> stub</span><span style="color:#F29668">.</span><span style="color:#FFB454">fetch</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'https://counter'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">  method</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> 'POST'</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">  body</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">({ type</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> 'INCREMENT'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> value</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 5</span><span style="color:#BFBDB6"> })</span></span>
<span class="line"><span style="color:#BFBDB6">})</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> counter </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> response</span><span style="color:#F29668">.</span><span style="color:#FFB454">json</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'Counter:'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> counter)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// counter.js - Durable Object</span></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> class</span><span style="color:#59C2FF"> Counter</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  constructor</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">state</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">state </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> state</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">    this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">counter </span><span style="color:#F29668">=</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">  async</span><span style="color:#FFB454"> fetch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">request</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> { type</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> value } </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> request</span><span style="color:#F29668">.</span><span style="color:#FFB454">json</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    if</span><span style="color:#BFBDB6"> (type </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> 'INCREMENT'</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#39BAE6;font-style:italic">      this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">counter </span><span style="color:#F29668">+=</span><span style="color:#BFBDB6"> value</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">      await</span><span style="color:#39BAE6;font-style:italic"> this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">state</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'counter'</span><span style="color:#BFBDB6B3">,</span><span style="color:#39BAE6;font-style:italic"> this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">counter)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">      return</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">(</span><span style="color:#39BAE6;font-style:italic">this</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">counter))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span></span>
<span class="line"><span style="color:#FF8F40">    return</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'Invalid request'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> { status</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 400</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>31:T1199,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// client.js - Client side</span></span>
<span class="line"><span style="color:#FF8F40">import</span><span style="color:#BFBDB6"> { createClient } </span><span style="color:#FF8F40">from</span><span style="color:#AAD94C"> '@rivetkit/actor'</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> client </span><span style="color:#F29668">=</span><span style="color:#FFB454"> createClient</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> counter </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> client</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">counter</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'counter-1'</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> result </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> counter</span><span style="color:#F29668">.</span><span style="color:#FFB454">increment</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">5</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'Counter:'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> result)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// counter.js - Actor definition</span></span>
<span class="line"><span style="color:#FF8F40">import</span><span style="color:#BFBDB6"> { actor } </span><span style="color:#FF8F40">from</span><span style="color:#AAD94C"> '@rivetkit/actor'</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> const</span><span style="color:#BFBDB6"> counter </span><span style="color:#F29668">=</span><span style="color:#FFB454"> actor</span><span style="color:#BFBDB6">({</span></span>
<span class="line"><span style="color:#BFBDB6">  state</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> { value</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6"> }</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">  actions</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">    increment</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">ctx</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> value</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      ctx</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">state</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">value </span><span style="color:#F29668">+=</span><span style="color:#BFBDB6"> value</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">      return</span><span style="color:#BFBDB6"> ctx</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">state</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">value</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">})</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>32:T536,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> client </span><span style="color:#F29668">=</span><span style="color:#FFB454"> createClient</span><span style="color:#BFBDB6">&#x3C;</span><span style="color:#59C2FF">App</span><span style="color:#BFBDB6">>(</span><span style="color:#AAD94C">"http://localhost:6420"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> randomChannel </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> client</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">chatRoom</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">({ organization</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "rivet"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> channel</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "random"</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>33:T57b,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> id </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> env</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">MY_DURABLE_OBJECT</span><span style="color:#F29668">.</span><span style="color:#FFB454">idFromName</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"channel:rivet:random"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> stub </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> env</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">MY_DURABLE_OBJECT</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(id)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">await</span><span style="color:#BFBDB6"> stub</span><span style="color:#F29668">.</span><span style="color:#FFB454">fetch</span><span style="color:#BFBDB6">(</span><span style="color:#F29668">...</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>34:T433,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">	fetch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">req</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">		const</span><span style="color:#BFBDB6"> worker </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> ServerlessWorker</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"./worker.js"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">		// ...</span></span>
<span class="line"><span style="color:#BFBDB6">	}</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>35:T578,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">	fetch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">req</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">		// ...</span></span>
<span class="line"><span style="color:#FF8F40">		const</span><span style="color:#BFBDB6"> worker </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> ServerlessWorker</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"./worker.js"</span><span style="color:#BFBDB6B3">,</span><span style="color:#AAD94C"> `chat-room-</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">random</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">		// ...</span></span>
<span class="line"><span style="color:#BFBDB6">	}</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>36:T968,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> sharedWorker </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> SharedWorker</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'sharedWorker.js'</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">sharedWorker</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">port</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">({ action</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> 'greet'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> data</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> 'Hello from Tab'</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">sharedWorker</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#FF8F40"> function</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">    console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'Received response from SharedWorker:'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">sharedWorker</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">port</span><span style="color:#F29668">.</span><span style="color:#FFB454">start</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>37:Ta83,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FFB454">onconnect</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">ports[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BFBDB6">    port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">        const</span><span style="color:#BFBDB6"> { action</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> data } </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">        if</span><span style="color:#BFBDB6"> (action </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> 'greet'</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">            port</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">({ response</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> `SharedWorker received: </span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">data</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">        }</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>38:T793,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">	fetch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">conn</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">		const</span><span style="color:#BFBDB6"> workerId </span><span style="color:#F29668">=</span><span style="color:#FFB454"> createServerlessWorkerId</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">		const</span><span style="color:#BFBDB6"> worker </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> ServerlessWorker</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"./worker.js"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> workerId)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">		conn</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">port</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">({ action</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> 'greet'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> data</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> 'foo'</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	}</span></span>
<span class="line"><span style="color:#BFBDB6">}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>39:Tca6,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">	connect</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">conn</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">		const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> conn</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">ports[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BFBDB6">		port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> event</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">			const</span><span style="color:#BFBDB6"> { action</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> data } </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">			if</span><span style="color:#BFBDB6"> (action </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> 'greet'</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">				conn</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">({ response</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> `Stateful serverless received: </span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">data</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">			}</span></span>
<span class="line"><span style="color:#BFBDB6">		}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BFBDB6">		port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onclose</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> event</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'Conn disconnected'</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	}</span></span>
<span class="line"><span style="color:#BFBDB6">}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>3a:Ta50,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">let</span><span style="color:#BFBDB6"> count </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">||</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">  connect</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">conn</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">	const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> conn</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">ports[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BFBDB6">    port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#FF8F40"> async</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      count </span><span style="color:#F29668">+=</span><span style="color:#D2A6FF"> 1</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">      await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> count)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>3b:T57f,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Set an alarm for 1 day</span></span>
<span class="line"><span style="color:#FFB454">setAlarm</span><span style="color:#BFBDB6">(Date</span><span style="color:#F29668">.</span><span style="color:#FFB454">now</span><span style="color:#BFBDB6">() </span><span style="color:#F29668">+</span><span style="color:#D2A6FF"> 86_400</span><span style="color:#F29668"> *</span><span style="color:#D2A6FF"> 1000</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">	alarm</span><span style="color:#BFBDB6">() {</span></span>
<span class="line"><span style="color:#BFBDB6">		console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"It's been 1 day"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">	}</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>3c:T241f,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// 10 requests/minute</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> maxRequests </span><span style="color:#F29668">=</span><span style="color:#D2A6FF"> 10</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> bucketDuration </span><span style="color:#F29668">=</span><span style="color:#D2A6FF"> 60_000</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Load state from storage</span></span>
<span class="line"><span style="color:#FF8F40">let</span><span style="color:#BFBDB6"> count </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">||</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">let</span><span style="color:#BFBDB6"> resetAt </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"resetAt"</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">||</span><span style="color:#BFBDB6"> (Date</span><span style="color:#F29668">.</span><span style="color:#FFB454">now</span><span style="color:#BFBDB6">() </span><span style="color:#F29668">+</span><span style="color:#BFBDB6"> bucketDuration)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">function</span><span style="color:#FFB454"> saveState</span><span style="color:#BFBDB6">() {</span></span>
<span class="line"><span style="color:#FF8F40">  await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"count"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> count)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">  await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"resetAt"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> resetAt)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">  connect</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">conn</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> conn</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">ports[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BFBDB6">    port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> { type</span><span style="color:#BFBDB6B3">,</span><span style="color:#F29668"> ...</span><span style="color:#BFBDB6">data } </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Check if bucket should be reset</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> now </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> Date</span><span style="color:#F29668">.</span><span style="color:#FFB454">now</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">      if</span><span style="color:#BFBDB6"> (now </span><span style="color:#F29668">>=</span><span style="color:#BFBDB6"> resetAt) {</span></span>
<span class="line"><span style="color:#BFBDB6">        count </span><span style="color:#F29668">=</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">        resetAt </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> now </span><span style="color:#F29668">+</span><span style="color:#BFBDB6"> bucketDuration</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">        saveState</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">      switch</span><span style="color:#BFBDB6"> (type) {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">        // Check if within rate limit</span></span>
<span class="line"><span style="color:#FF8F40">        case</span><span style="color:#AAD94C"> "HIT"</span><span style="color:#BFBDB6">:</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">          // Update limit</span></span>
<span class="line"><span style="color:#FF8F40">          const</span><span style="color:#BFBDB6"> isAllowed </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> count </span><span style="color:#F29668">&#x3C;</span><span style="color:#BFBDB6"> maxRequests</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">          if</span><span style="color:#BFBDB6"> (isAllowed) {</span></span>
<span class="line"><span style="color:#BFBDB6">            count </span><span style="color:#F29668">+=</span><span style="color:#D2A6FF"> 1</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">            saveState</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">          }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BFBDB6">          conn</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">({ isAllowed })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">          break</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">        // Reset rate limit (unused, purely for example)</span></span>
<span class="line"><span style="color:#FF8F40">        case</span><span style="color:#AAD94C"> "RESET"</span><span style="color:#BFBDB6">:</span></span>
<span class="line"><span style="color:#BFBDB6">          count </span><span style="color:#F29668">=</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">          resetAt </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> now </span><span style="color:#F29668">+</span><span style="color:#BFBDB6"> bucketDuration</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FFB454">          saveState</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">          break</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>3d:T1c8f,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  async</span><span style="color:#FFB454"> fetch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">request</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> env</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> url </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> URL</span><span style="color:#BFBDB6">(request</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">url)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Get client IP</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> forwardedFor </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> request</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">headers</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'x-forwarded-for'</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">||</span><span style="color:#AAD94C"> '127.0.0.1'</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> clientIp </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> forwardedFor</span><span style="color:#F29668">.</span><span style="color:#FFB454">split</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">','</span><span style="color:#BFBDB6">)[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#F29668">.</span><span style="color:#FFB454">trim</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Create a rate limiter for this IP</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> limiterId </span><span style="color:#F29668">=</span><span style="color:#AAD94C"> `rate-limit:</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">ip</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> worker </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> ServerlessWorker</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"./rateLimiter.js"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> limiterId)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Handle response</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> { promise</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> resolve</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> reject } </span><span style="color:#F29668">=</span><span style="color:#39BAE6"> Promise</span><span style="color:#F29668">.</span><span style="color:#FFB454">withResolvers</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    worker</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> { isAllowed } </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#FF8F40">      if</span><span style="color:#BFBDB6"> (isAllowed) {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">        // Request is allowed - continue to handle the actual request</span></span>
<span class="line"><span style="color:#FFB454">        resolve</span><span style="color:#BFBDB6">(</span><span style="color:#F29668">new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Request allowed"</span><span style="color:#BFBDB6">))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      } </span><span style="color:#FF8F40">else</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">        // Request is rate limited</span></span>
<span class="line"><span style="color:#FFB454">        resolve</span><span style="color:#BFBDB6">(</span><span style="color:#F29668">new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Rate limit exceeded"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> { status</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 429</span><span style="color:#BFBDB6"> }))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Send the rate limit check</span></span>
<span class="line"><span style="color:#BFBDB6">    worker</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">port</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">({ type</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "HIT"</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">    return</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> promise</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>3e:T128b,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// A set of all connected clients</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> subscribers </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Set</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">  connect</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">ports[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    subscribers</span><span style="color:#F29668">.</span><span style="color:#FFB454">add</span><span style="color:#BFBDB6">(port)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#BFBDB6">    port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> event</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> { type</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> data } </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#FF8F40">      if</span><span style="color:#BFBDB6"> (type </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> "publish"</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">        // Broadcast to all subscribers</span></span>
<span class="line"><span style="color:#FF8F40">        for</span><span style="color:#BFBDB6"> (</span><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> client </span><span style="color:#F29668">of</span><span style="color:#BFBDB6"> subscribers) {</span></span>
<span class="line"><span style="color:#BFBDB6">          client</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">({</span></span>
<span class="line"><span style="color:#BFBDB6">            type</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "message"</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">            data</span></span>
<span class="line"><span style="color:#BFBDB6">          })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">        }</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Remove on disconnect</span></span>
<span class="line"><span style="color:#BFBDB6">    port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onclose</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> () </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      subscribers</span><span style="color:#F29668">.</span><span style="color:#FFB454">delete</span><span style="color:#BFBDB6">(port)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>3f:T2560,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  async</span><span style="color:#FFB454"> fetch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">request</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> url </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> URL</span><span style="color:#BFBDB6">(request</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">url)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> [_</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> topic] </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> url</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">pathname</span><span style="color:#F29668">.</span><span style="color:#FFB454">split</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'/'</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#FF8F40">    if</span><span style="color:#BFBDB6"> (</span><span style="color:#F29668">!</span><span style="color:#BFBDB6">topic) {</span></span>
<span class="line"><span style="color:#FF8F40">      return</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Specify a topic in the URL path"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Each topic gets its own worker</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> worker </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> ServerlessWorker</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"./topicWorker.js"</span><span style="color:#BFBDB6B3">,</span><span style="color:#AAD94C"> `topic-</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">topic</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Handle WebSocket upgrade</span></span>
<span class="line"><span style="color:#FF8F40">    if</span><span style="color:#BFBDB6"> (request</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">headers</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Upgrade"</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> "websocket"</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> pair </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> WebSocketPair</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> client </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> pair[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> server </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> pair[</span><span style="color:#D2A6FF">1</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Connect to worker</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> worker</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">port</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Client -> Worker</span></span>
<span class="line"><span style="color:#BFBDB6">      server</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> event</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">        try</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">          port</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">parse</span><span style="color:#BFBDB6">(event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">        } </span><span style="color:#FF8F40">catch</span><span style="color:#BFBDB6"> (err) {</span></span>
<span class="line"><span style="color:#BFBDB6">          server</span><span style="color:#F29668">.</span><span style="color:#FFB454">send</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">({ error</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "Invalid JSON"</span><span style="color:#BFBDB6"> }))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">        }</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Worker -> Client</span></span>
<span class="line"><span style="color:#BFBDB6">      port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> event</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">        server</span><span style="color:#F29668">.</span><span style="color:#FFB454">send</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">(event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#BFBDB6">      server</span><span style="color:#F29668">.</span><span style="color:#FFB454">accept</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#FF8F40">      return</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">null</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">        status</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 101</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">        webSocket</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> client</span></span>
<span class="line"><span style="color:#BFBDB6">      })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#FF8F40">    return</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Expected WebSocket"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>40:Tef6,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Subscribe to a topic</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> ws </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> WebSocket</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"wss://pubsub.example.com/news"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Handle incoming messages</span></span>
<span class="line"><span style="color:#BFBDB6">ws</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> event</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  const</span><span style="color:#BFBDB6"> { type</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> data } </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">parse</span><span style="color:#BFBDB6">(event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  </span></span>
<span class="line"><span style="color:#FF8F40">  if</span><span style="color:#BFBDB6"> (type </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> "message"</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">    console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"New message:"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> data)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Publish a message to the topic</span></span>
<span class="line"><span style="color:#FF8F40">function</span><span style="color:#FFB454"> publish</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">data</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">  ws</span><span style="color:#F29668">.</span><span style="color:#FFB454">send</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">({</span></span>
<span class="line"><span style="color:#BFBDB6">    type</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "publish"</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">    data</span></span>
<span class="line"><span style="color:#BFBDB6">  }))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Example usage</span></span>
<span class="line"><span style="color:#FFB454">publish</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Breaking news!"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>41:T2990,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Keep track of all connections to this chat room</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> connections </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Set</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Keep messages in memory</span></span>
<span class="line"><span style="color:#FF8F40">let</span><span style="color:#BFBDB6"> messages </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"messages"</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">??</span><span style="color:#BFBDB6"> []</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Broadcast a message to all connected clients</span></span>
<span class="line"><span style="color:#FF8F40">function</span><span style="color:#FFB454"> broadcast</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">message</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">  for</span><span style="color:#BFBDB6"> (</span><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> conn </span><span style="color:#F29668">of</span><span style="color:#BFBDB6"> connections) {</span></span>
<span class="line"><span style="color:#BFBDB6">    conn</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">(message)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">  connect</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">ports[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    connections</span><span style="color:#F29668">.</span><span style="color:#FFB454">add</span><span style="color:#BFBDB6">(port)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Send message history to new client</span></span>
<span class="line"><span style="color:#FF8F40">    if</span><span style="color:#BFBDB6"> (messages</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">length </span><span style="color:#F29668">></span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">      port</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">({</span></span>
<span class="line"><span style="color:#BFBDB6">        type</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "history"</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">        messages</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> messages</span><span style="color:#F29668">.</span><span style="color:#FFB454">slice</span><span style="color:#BFBDB6">(</span><span style="color:#F29668">-</span><span style="color:#D2A6FF">20</span><span style="color:#BFBDB6">)</span></span>
<span class="line"><span style="color:#BFBDB6">      })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#BFBDB6">    port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#FF8F40"> async</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> { text</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> username } </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Create message object</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> message </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">        text</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">        username</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">        timestamp</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> Date</span><span style="color:#F29668">.</span><span style="color:#FFB454">now</span><span style="color:#BFBDB6">()</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Store message</span></span>
<span class="line"><span style="color:#BFBDB6">      messages</span><span style="color:#F29668">.</span><span style="color:#FFB454">push</span><span style="color:#BFBDB6">(message)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Save periodically </span></span>
<span class="line"><span style="color:#FF8F40">      if</span><span style="color:#BFBDB6"> (messages</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">length </span><span style="color:#F29668">%</span><span style="color:#D2A6FF"> 10</span><span style="color:#F29668"> ===</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">        await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"messages"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> messages)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Broadcast to all clients</span></span>
<span class="line"><span style="color:#FFB454">      broadcast</span><span style="color:#BFBDB6">({</span></span>
<span class="line"><span style="color:#BFBDB6">        type</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "message"</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">        message</span></span>
<span class="line"><span style="color:#BFBDB6">      })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Handle client disconnection</span></span>
<span class="line"><span style="color:#BFBDB6">    port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onclose</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> () </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      connections</span><span style="color:#F29668">.</span><span style="color:#FFB454">delete</span><span style="color:#BFBDB6">(port)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // If this was the last connection, save messages</span></span>
<span class="line"><span style="color:#FF8F40">      if</span><span style="color:#BFBDB6"> (connections</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">size </span><span style="color:#F29668">===</span><span style="color:#D2A6FF"> 0</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FFB454">        waitUntil</span><span style="color:#BFBDB6">(storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"messages"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> messages))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>42:T2b38,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  async</span><span style="color:#FFB454"> fetch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">request</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> url </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> URL</span><span style="color:#BFBDB6">(request</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">url)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Get chat room name from URL</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> [_</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> roomId] </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> url</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">pathname</span><span style="color:#F29668">.</span><span style="color:#FFB454">split</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'/'</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#FF8F40">    if</span><span style="color:#BFBDB6"> (</span><span style="color:#F29668">!</span><span style="color:#BFBDB6">roomId) {</span></span>
<span class="line"><span style="color:#FF8F40">      return</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Please specify a room ID in the URL path"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> { status</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 400</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Get or create a worker for this room</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> worker </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> ServerlessWorker</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"./chatRoom.js"</span><span style="color:#BFBDB6B3">,</span><span style="color:#AAD94C"> `chat-</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">roomId</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Handle websocket upgrade</span></span>
<span class="line"><span style="color:#FF8F40">    if</span><span style="color:#BFBDB6"> (request</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">headers</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'Upgrade'</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">!==</span><span style="color:#AAD94C"> 'websocket'</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">      return</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">'Expected websocket'</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> { status</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 426</span><span style="color:#BFBDB6"> })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Create a WebSocket pair</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> pair </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> WebSocketPair</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> client </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> pair[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> server </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> pair[</span><span style="color:#D2A6FF">1</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Connect client and worker</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> worker</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">port</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Client -> Worker</span></span>
<span class="line"><span style="color:#BFBDB6">    server</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">      try</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">        port</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">parse</span><span style="color:#BFBDB6">(event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      } </span><span style="color:#FF8F40">catch</span><span style="color:#BFBDB6"> (err) {</span></span>
<span class="line"><span style="color:#BFBDB6">        server</span><span style="color:#F29668">.</span><span style="color:#FFB454">send</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">({ error</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "Invalid JSON"</span><span style="color:#BFBDB6"> }))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Worker -> Client</span></span>
<span class="line"><span style="color:#BFBDB6">    port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      server</span><span style="color:#F29668">.</span><span style="color:#FFB454">send</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">(event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Handle WebSocket close</span></span>
<span class="line"><span style="color:#BFBDB6">    server</span><span style="color:#F29668">.</span><span style="color:#FFB454">onclose</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> () </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      port</span><span style="color:#F29668">.</span><span style="color:#FFB454">close</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#BFBDB6">    server</span><span style="color:#F29668">.</span><span style="color:#FFB454">accept</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#FF8F40">    return</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">null</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      status</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 101</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">      webSocket</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> client</span></span>
<span class="line"><span style="color:#BFBDB6">    })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>43:T1d99,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Connect to a chat room</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> username </span><span style="color:#F29668">=</span><span style="color:#AAD94C"> "user"</span><span style="color:#F29668"> +</span><span style="color:#BFBDB6"> Math</span><span style="color:#F29668">.</span><span style="color:#FFB454">floor</span><span style="color:#BFBDB6">(Math</span><span style="color:#F29668">.</span><span style="color:#FFB454">random</span><span style="color:#BFBDB6">() </span><span style="color:#F29668">*</span><span style="color:#D2A6FF"> 1000</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">const</span><span style="color:#BFBDB6"> ws </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> WebSocket</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"wss://chat.example.com/room123"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Handle incoming messages</span></span>
<span class="line"><span style="color:#BFBDB6">ws</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> event</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  const</span><span style="color:#BFBDB6"> data </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">parse</span><span style="color:#BFBDB6">(event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  </span></span>
<span class="line"><span style="color:#FF8F40">  if</span><span style="color:#BFBDB6"> (data</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">type </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> "message"</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">    console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">`</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">data</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">message</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">username</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">: </span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">data</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">message</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">text</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  } </span><span style="color:#FF8F40">else</span><span style="color:#FF8F40"> if</span><span style="color:#BFBDB6"> (data</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">type </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> "history"</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">    console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"--- Message History ---"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    data</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">messages</span><span style="color:#F29668">.</span><span style="color:#FFB454">forEach</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">msg</span><span style="color:#FF8F40"> =></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">`</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">msg</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">username</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">: </span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">msg</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">text</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"---------------------"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Send a chat message</span></span>
<span class="line"><span style="color:#FF8F40">function</span><span style="color:#FFB454"> sendMessage</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">text</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">  ws</span><span style="color:#F29668">.</span><span style="color:#FFB454">send</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">({</span></span>
<span class="line"><span style="color:#BFBDB6">    text</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">    username</span></span>
<span class="line"><span style="color:#BFBDB6">  }))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Example usage</span></span>
<span class="line"><span style="color:#BFBDB6">ws</span><span style="color:#F29668">.</span><span style="color:#FFB454">onopen</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> () </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">  sendMessage</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Hello everyone!"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>44:T2963,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">  connect</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">ports[</span><span style="color:#D2A6FF">0</span><span style="color:#BFBDB6">]</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#BFBDB6">    port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#FF8F40"> async</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> { command</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> key</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> value } </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">      let</span><span style="color:#BFBDB6"> response</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Handle different Redis-like commands - directly using storage API</span></span>
<span class="line"><span style="color:#FF8F40">      switch</span><span style="color:#BFBDB6"> (command) {</span></span>
<span class="line"><span style="color:#FF8F40">        case</span><span style="color:#AAD94C"> "GET"</span><span style="color:#BFBDB6">:</span></span>
<span class="line"><span style="color:#FF8F40">          const</span><span style="color:#BFBDB6"> storedValue </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">`key:</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">key</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">          response </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> { </span></span>
<span class="line"><span style="color:#BFBDB6">            status</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "success"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> </span></span>
<span class="line"><span style="color:#BFBDB6">            value</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> storedValue </span><span style="color:#F29668">!==</span><span style="color:#D2A6FF"> undefined</span><span style="color:#F29668"> ?</span><span style="color:#BFBDB6"> storedValue </span><span style="color:#F29668">:</span><span style="color:#D2A6FF"> null</span><span style="color:#BFBDB6"> </span></span>
<span class="line"><span style="color:#BFBDB6">          }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">          break</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">          </span></span>
<span class="line"><span style="color:#FF8F40">        case</span><span style="color:#AAD94C"> "SET"</span><span style="color:#BFBDB6">:</span></span>
<span class="line"><span style="color:#FF8F40">          await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">put</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">`key:</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">key</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> value)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">          response </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> { status</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "success"</span><span style="color:#BFBDB6"> }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">          break</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">          </span></span>
<span class="line"><span style="color:#FF8F40">        case</span><span style="color:#AAD94C"> "DEL"</span><span style="color:#BFBDB6">:</span></span>
<span class="line"><span style="color:#FF8F40">          const</span><span style="color:#BFBDB6"> exists </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">get</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">`key:</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">key</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6">) </span><span style="color:#F29668">!==</span><span style="color:#D2A6FF"> undefined</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">          if</span><span style="color:#BFBDB6"> (exists) {</span></span>
<span class="line"><span style="color:#FF8F40">            await</span><span style="color:#BFBDB6"> storage</span><span style="color:#F29668">.</span><span style="color:#FFB454">delete</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">`key:</span><span style="color:#FF8F40">${</span><span style="color:#BFBDB6">key</span><span style="color:#FF8F40">}</span><span style="color:#AAD94C">`</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">          }</span></span>
<span class="line"><span style="color:#BFBDB6">          response </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> { </span></span>
<span class="line"><span style="color:#BFBDB6">            status</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "success"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> </span></span>
<span class="line"><span style="color:#BFBDB6">            deleted</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> exists</span></span>
<span class="line"><span style="color:#BFBDB6">          }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">          break</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">          </span></span>
<span class="line"><span style="color:#FF8F40">        case</span><span style="color:#AAD94C"> "KEYS"</span><span style="color:#BFBDB6">:</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">          // For a real implementation, this would need support from the platform</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">          // to list keys with a specific prefix or pattern</span></span>
<span class="line"><span style="color:#BFBDB6">          response </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> { </span></span>
<span class="line"><span style="color:#BFBDB6">            status</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "error"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> </span></span>
<span class="line"><span style="color:#BFBDB6">            message</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "KEYS command not supported in this simplified implementation"</span><span style="color:#BFBDB6"> </span></span>
<span class="line"><span style="color:#BFBDB6">          }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">          break</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">          </span></span>
<span class="line"><span style="color:#FF8F40">        default</span><span style="color:#BFBDB6">:</span></span>
<span class="line"><span style="color:#BFBDB6">          response </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> { </span></span>
<span class="line"><span style="color:#BFBDB6">            status</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "error"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> </span></span>
<span class="line"><span style="color:#BFBDB6">            message</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "Unknown command"</span><span style="color:#BFBDB6"> </span></span>
<span class="line"><span style="color:#BFBDB6">          }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#BFBDB6">      port</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">(response)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>45:T1c81,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#FF8F40">export</span><span style="color:#FF8F40"> default</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FF8F40">  async</span><span style="color:#FFB454"> fetch</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">request</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> url </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> URL</span><span style="color:#BFBDB6">(request</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">url)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Create or access the Redis worker</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // We use a single worker for the entire Redis server</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> worker </span><span style="color:#F29668">=</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> ServerlessWorker</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"./redisWorker.js"</span><span style="color:#BFBDB6B3">,</span><span style="color:#AAD94C"> "redis-server"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">    const</span><span style="color:#BFBDB6"> port </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> worker</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">port</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">    // Handle POST requests for Redis commands</span></span>
<span class="line"><span style="color:#FF8F40">    if</span><span style="color:#BFBDB6"> (request</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">method </span><span style="color:#F29668">===</span><span style="color:#AAD94C"> "POST"</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Parse the command from the request body</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> command </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> request</span><span style="color:#F29668">.</span><span style="color:#FFB454">json</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Create a Promise that will be resolved with the response</span></span>
<span class="line"><span style="color:#FF8F40">      const</span><span style="color:#BFBDB6"> { promise</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> resolve } </span><span style="color:#F29668">=</span><span style="color:#39BAE6"> Promise</span><span style="color:#F29668">.</span><span style="color:#FFB454">withResolvers</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Set up message handler</span></span>
<span class="line"><span style="color:#BFBDB6">      port</span><span style="color:#F29668">.</span><span style="color:#FFB454">onmessage</span><span style="color:#F29668"> =</span><span style="color:#BFBDB6"> (</span><span style="color:#D2A6FF">event</span><span style="color:#BFBDB6">) </span><span style="color:#FF8F40">=></span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#FFB454">        resolve</span><span style="color:#BFBDB6">(</span><span style="color:#F29668">new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">(event</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">data)</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">          headers</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> { </span><span style="color:#AAD94C">"Content-Type"</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "application/json"</span><span style="color:#BFBDB6"> }</span></span>
<span class="line"><span style="color:#BFBDB6">        }))</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Send the command to the worker</span></span>
<span class="line"><span style="color:#BFBDB6">      port</span><span style="color:#F29668">.</span><span style="color:#FFB454">postMessage</span><span style="color:#BFBDB6">(command)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">      </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">      // Wait for the response</span></span>
<span class="line"><span style="color:#FF8F40">      return</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> promise</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">    }</span></span>
<span class="line"><span style="color:#BFBDB6">    </span></span>
<span class="line"><span style="color:#FF8F40">    return</span><span style="color:#F29668"> new</span><span style="color:#FFB454"> Response</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Invalid method"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">      status</span><span style="color:#BFBDB6B3">:</span><span style="color:#D2A6FF"> 400</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">      headers</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> { </span><span style="color:#AAD94C">"Content-Type"</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "text/plain"</span><span style="color:#BFBDB6"> }</span></span>
<span class="line"><span style="color:#BFBDB6">    })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span></code></pre>46:T2018,<pre class="shiki ayu-dark" style="background-color:#0c0a09;color:#bfbdb6" tabindex="0"><code><span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Redis client example</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Function to send a command to the Redis server</span></span>
<span class="line"><span style="color:#FF8F40">async</span><span style="color:#FF8F40"> function</span><span style="color:#FFB454"> redisCommand</span><span style="color:#BFBDB6">(</span><span style="color:#D2A6FF">command</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> key</span><span style="color:#BFBDB6B3">,</span><span style="color:#D2A6FF"> value</span><span style="color:#F29668"> =</span><span style="color:#D2A6FF"> null</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#FF8F40">  const</span><span style="color:#BFBDB6"> payload </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> { command</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> key }</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#FF8F40">  if</span><span style="color:#BFBDB6"> (value </span><span style="color:#F29668">!==</span><span style="color:#D2A6FF"> null</span><span style="color:#BFBDB6">) {</span></span>
<span class="line"><span style="color:#BFBDB6">    payload</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">value </span><span style="color:#F29668">=</span><span style="color:#BFBDB6"> value</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  }</span></span>
<span class="line"><span style="color:#BFBDB6">  </span></span>
<span class="line"><span style="color:#FF8F40">  const</span><span style="color:#BFBDB6"> response </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#FFB454"> fetch</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"https://redis.example.com"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> {</span></span>
<span class="line"><span style="color:#BFBDB6">    method</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "POST"</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">    headers</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> { </span><span style="color:#AAD94C">"Content-Type"</span><span style="color:#BFBDB6B3">:</span><span style="color:#AAD94C"> "application/json"</span><span style="color:#BFBDB6"> }</span><span style="color:#BFBDB6B3">,</span></span>
<span class="line"><span style="color:#BFBDB6">    body</span><span style="color:#BFBDB6B3">:</span><span style="color:#BFBDB6"> JSON</span><span style="color:#F29668">.</span><span style="color:#FFB454">stringify</span><span style="color:#BFBDB6">(payload)</span></span>
<span class="line"><span style="color:#BFBDB6">  })</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  </span></span>
<span class="line"><span style="color:#FF8F40">  return</span><span style="color:#FF8F40"> await</span><span style="color:#BFBDB6"> response</span><span style="color:#F29668">.</span><span style="color:#FFB454">json</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">// Example usage</span></span>
<span class="line"><span style="color:#FF8F40">async</span><span style="color:#FF8F40"> function</span><span style="color:#FFB454"> example</span><span style="color:#BFBDB6">() {</span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">  // Set a value</span></span>
<span class="line"><span style="color:#FF8F40">  await</span><span style="color:#FFB454"> redisCommand</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"SET"</span><span style="color:#BFBDB6B3">,</span><span style="color:#AAD94C"> "greeting"</span><span style="color:#BFBDB6B3">,</span><span style="color:#AAD94C"> "Hello, ServerlessWorker!"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Set greeting key"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">  // Get the value</span></span>
<span class="line"><span style="color:#FF8F40">  const</span><span style="color:#BFBDB6"> result </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#FFB454"> redisCommand</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"GET"</span><span style="color:#BFBDB6B3">,</span><span style="color:#AAD94C"> "greeting"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Get greeting:"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> result</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">value)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">  // Delete the key</span></span>
<span class="line"><span style="color:#FF8F40">  const</span><span style="color:#BFBDB6"> deleted </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#FFB454"> redisCommand</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"DEL"</span><span style="color:#BFBDB6B3">,</span><span style="color:#AAD94C"> "greeting"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"Deleted greeting:"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> deleted</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">deleted)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  </span></span>
<span class="line"><span style="color:#ACB6BF8C;font-style:italic">  // Verify it's gone</span></span>
<span class="line"><span style="color:#FF8F40">  const</span><span style="color:#BFBDB6"> afterDelete </span><span style="color:#F29668">=</span><span style="color:#FF8F40"> await</span><span style="color:#FFB454"> redisCommand</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"GET"</span><span style="color:#BFBDB6B3">,</span><span style="color:#AAD94C"> "greeting"</span><span style="color:#BFBDB6">)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">  console</span><span style="color:#F29668">.</span><span style="color:#FFB454">log</span><span style="color:#BFBDB6">(</span><span style="color:#AAD94C">"After delete:"</span><span style="color:#BFBDB6B3">,</span><span style="color:#BFBDB6"> afterDelete</span><span style="color:#F29668">.</span><span style="color:#BFBDB6">value)</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"><span style="color:#BFBDB6">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFB454">example</span><span style="color:#BFBDB6">()</span><span style="color:#BFBDB6B3">;</span></span>
<span class="line"></span></code></pre>e:[["$","div",null,{"className":"mx-auto mt-20 w-full max-w-6xl px-4 md:mt-32 max-w-[1440px]","style":{"--header-height":"5rem"},"children":[["$","ul",null,{"className":"text-muted-foreground my-4 flex flex-wrap items-center gap-2 text-xs","children":[["$","li",null,{"children":["$","$La",null,{"href":"/blog","children":"Blog"}]}],["$","li",null,{"className":"h-2.5","children":["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"chevron-right","className":"svg-inline--fa fa-chevron-right block h-full w-auto","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 320 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z","style":{}}]}]}],["$","li",null,{"children":"Technical"}],["$","li",null,{"className":"h-2.5","children":["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"chevron-right","className":"svg-inline--fa fa-chevron-right block h-full w-auto","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 320 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z","style":{}}]}]}],["$","li",null,{"className":"text-foreground font-semibold","children":"Considering A W3C Standard For Stateful Serverless"}]]}],["$","div",null,{"className":"flex flex-col gap-8 pb-6 lg:flex-row","children":[["$","aside",null,{"className":"order-1 mt-2 flex min-w-0 max-w-s flex-1 flex-col gap-2","children":["$","div",null,{"className":"top-header sticky pt-2","children":[["$","p",null,{"className":"mb-2 text-sm font-semibold","children":"Posted by"}],["$","div",null,{"className":"mb-4 flex items-center gap-2","children":[["$","$L1b",null,{"className":"mt-1 size-14","children":[["$","$L1c",null,{"children":"$undefined"}],["$","$L1d",null,{"src":"/_next/static/media/avatar.7191d056.jpeg","height":1516,"width":1516,"blurDataURL":"data:image/jpeg;base64,/9j/2wBDAAoKCgoKCgsMDAsPEA4QDxYUExMUFiIYGhgaGCIzICUgICUgMy03LCksNy1RQDg4QFFeT0pPXnFlZXGPiI+7u/v/2wBDAQoKCgoKCgsMDAsPEA4QDxYUExMUFiIYGhgaGCIzICUgICUgMy03LCksNy1RQDg4QFFeT0pPXnFlZXGPiI+7u/v/wgARCAAIAAgDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAb/xAAVAQEBAAAAAAAAAAAAAAAAAAAEBf/aAAwDAQACEAMQAAAApxJX/8QAHBAAAgICAwAAAAAAAAAAAAAAAQIDEgAEBREj/9oACAEBAAE/AIG3H5iX2rpIoRIq1UmvbHP/xAAXEQADAQAAAAAAAAAAAAAAAAAAAhNh/9oACAECAQE/AKNh/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAIBIXH/2gAIAQMBAT8AlFrD/9k=","blurWidth":8,"blurHeight":8,"alt":{"name":"Nathan Flurry","role":"Co-founder & CTO","avatar":{"src":"/_next/static/media/avatar.7191d056.jpeg","height":1516,"width":1516,"blurDataURL":"data:image/jpeg;base64,/9j/2wBDAAoKCgoKCgsMDAsPEA4QDxYUExMUFiIYGhgaGCIzICUgICUgMy03LCksNy1RQDg4QFFeT0pPXnFlZXGPiI+7u/v/2wBDAQoKCgoKCgsMDAsPEA4QDxYUExMUFiIYGhgaGCIzICUgICUgMy03LCksNy1RQDg4QFFeT0pPXnFlZXGPiI+7u/v/wgARCAAIAAgDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAb/xAAVAQEBAAAAAAAAAAAAAAAAAAAEBf/aAAwDAQACEAMQAAAApxJX/8QAHBAAAgICAwAAAAAAAAAAAAAAAQIDEgAEBREj/9oACAEBAAE/AIG3H5iX2rpIoRIq1UmvbHP/xAAXEQADAQAAAAAAAAAAAAAAAAAAAhNh/9oACAECAQE/AKNh/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAIBIXH/2gAIAQMBAT8AlFrD/9k=","blurWidth":8,"blurHeight":8},"socials":{"twitter":"https://x.com/NathanFlurry/","github":"https://github.com/nathanflurry","bluesky":"https://bsky.app/profile/nathanflurry.com"}}}]]}],["$","div",null,{"className":"flex flex-col","children":[["$","h3",null,{"className":"font-bold","children":"Nathan Flurry"}],["$","p",null,{"className":"text-muted-foreground text-sm","children":"Co-founder & CTO"}],["$","p",null,{"className":"flex gap-2 text-xs text-muted-foreground mt-1","children":[["$","a",null,{"href":"https://x.com/NathanFlurry/","target":"_blank","rel":"noopener noreferrer","children":["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fab","data-icon":"x-twitter","className":"svg-inline--fa fa-x-twitter ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 512 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z","style":{}}]}]}],["$","a",null,{"href":"https://bsky.app/profile/nathanflurry.com","target":"_blank","rel":"noopener noreferrer","children":["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fab","data-icon":"bluesky","className":"svg-inline--fa fa-bluesky ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 512 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M111.8 62.2C170.2 105.9 233 194.7 256 242.4c23-47.6 85.8-136.4 144.2-180.2c42.1-31.6 110.3-56 110.3 21.8c0 15.5-8.9 130.5-14.1 149.2C478.2 298 412 314.6 353.1 304.5c102.9 17.5 129.1 75.5 72.5 133.5c-107.4 110.2-154.3-27.6-166.3-62.9l0 0c-1.7-4.9-2.6-7.8-3.3-7.8s-1.6 3-3.3 7.8l0 0c-12 35.3-59 173.1-166.3 62.9c-56.5-58-30.4-116 72.5-133.5C100 314.6 33.8 298 15.7 233.1C10.4 214.4 1.5 99.4 1.5 83.9c0-77.8 68.2-53.4 110.3-21.8z","style":{}}]}]}],["$","a",null,{"href":"https://github.com/nathanflurry","target":"_blank","rel":"noopener noreferrer","children":["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fab","data-icon":"github","className":"svg-inline--fa fa-github ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 496 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"$1e","style":{}}]}]}]]}]]}]]}],["$","div",null,{"className":"text-muted-foreground mb-6 flex items-center gap-2 text-sm","children":[["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"calendar-day","className":"svg-inline--fa fa-calendar-day ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M128 0c17.7 0 32 14.3 32 32l0 32 128 0 0-32c0-17.7 14.3-32 32-32s32 14.3 32 32l0 32 48 0c26.5 0 48 21.5 48 48l0 48L0 160l0-48C0 85.5 21.5 64 48 64l48 0 0-32c0-17.7 14.3-32 32-32zM0 192l448 0 0 272c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 192zm80 64c-8.8 0-16 7.2-16 16l0 96c0 8.8 7.2 16 16 16l96 0c8.8 0 16-7.2 16-16l0-96c0-8.8-7.2-16-16-16l-96 0z","style":{}}]}],["$","time",null,{"className":"text-sm","children":"March 23, 2025"}]]}],["$","p",null,{"className":"mb-2 hidden text-sm font-semibold lg:block","children":"Other articles"}],"$L1f"]}]}],["$","article",null,{"className":"order-3 mt-4 w-full flex-shrink-0 lg:order-2 xl:max-w-[1000px] prose-invert prose","children":[["$","$L20",null,{"src":"/_next/static/media/image.00c62794.png","height":1024,"width":2048,"blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAECAMAAACEE47CAAAAElBMVEUREREaFBMkISEbHBw4OTpJSUl/57+ZAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAH0lEQVR4nGNgYmRkAANmFhYmBmYmRgYmVlZmRhADBgADnwAuL6FfMQAAAABJRU5ErkJggg==","blurWidth":8,"blurHeight":4,"alt":"Promo Image","className":"rounded-xl border border-white/10"}],[["$","h1",null,{"children":"Considering A W3C Standard For Stateful Serverless"}],"\n",["$","p",null,{"children":["$","strong",null,{"children":["We're Rivet, a new open-source, self-hostable serverless platform with a focus on stateful serverless. If you want to support our mission of building a production-ready and self-hostable serverless runtime, ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivet","target":"_blank","children":"give us a star on GitHub"}],"."]}]}],"\n",["$","p",null,{"children":["Earlier today, I was ",["$","$La",null,{"href":"https://x.com/janwilmake/status/1903580372920590667","target":"_blank","children":"called upon"}]," by Cloudflare's ",["$","$La",null,{"href":"https://x.com/threepointone","target":"_blank","children":"@threepointone"}]," and ",["$","$La",null,{"href":"https://x.com/janwilmake","target":"_blank","children":"@janwilmake"}]," regarding my thoughts on a standard for stateful serverless."]}],"\n",["$","$La",null,{"href":"https://x.com/janwilmake/status/1903580372920590667","target":"_blank","children":["$","$L20",null,{"src":{"src":"/_next/static/media/tweet.5d715dca.png","height":2264,"width":2388,"blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAACVBMVEUEBQUTFBQjIh31scrwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAJklEQVR4nD2KQQ4AIAyDKP9/tLFuciElxXAJlq6XVvI/mYSmwPgABmYALJjpHYIAAAAASUVORK5CYII=","blurWidth":8,"blurHeight":8},"alt":"threepointone tweet"}]}],"\n",["$","p",null,{"children":["Having implemented a cloud-agnostic stateful serverless library called ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit","target":"_blank","children":"RivetKit"}],", I have a lot of experience with what's required to build a portable standard. And thus, I derailed my Saturday to write them down here."]}],"\n",["$","p",null,{"children":["This specification is intended as step 1 to start the conversation about what is required to develop a stateful serverless specification that makes stateful serverless easier for companies to adopt. I don't expect this to be the end result. See ",["$","em",null,{"children":"Specification Goals"}]," for more information."]}],"\n",["$","$L21",null,{"level":2,"id":"what-is-stateful-serverless","children":"What Is Stateful Serverless?"}],"\n",["$","p",null,{"children":["Unless you're deep in to ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/","target":"_blank","children":"Cloudflare Durable Objects"}]," or ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/actors","target":"_blank","children":"Rivet Actors"}],", there's a good chance you've never heard of \"stateful serverless.\""]}],"\n",["$","p",null,{"children":[["$","strong",null,{"children":"Stateful serverless"}]," allows serverless functions to maintain state across multiple invocations. They're very similar to ",["$","strong",null,{"children":["Web Workers (specifically ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}],") on the server"]}]," and share characteristics with the ",["$","strong",null,{"children":"actor model"}],". The most popular implementation of this today is ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/","target":"_blank","children":"Durable Objects"}],"."]}],"\n",["$","p",null,{"children":["The adoption of stateful serverless is fairly new: Durable Objects was announced ",["$","$La",null,{"href":"https://blog.cloudflare.com/introducing-workers-durable-objects/","target":"_blank","children":"4.5 years ago"}]," and only recently saw widespread use over the past couple years."]}],"\n",["$","$L21",null,{"level":3,"id":"stateless-serverless-functions-vs-stateful-serverless-workers","children":"Stateless Serverless (Functions) vs Stateful Serverless (Workers)"}],"\n",["$","p",null,{"children":[["$","strong",null,{"children":"Stateless serverless"}]," is what you'd normally think of when you hear ",["$","strong",null,{"children":"\"serverless functions.\""}]," An example implementation on Cloudflare Workers would look like this:"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"TypeScript"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"<pre class=\"shiki ayu-dark\" style=\"background-color:#0c0a09;color:#bfbdb6\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#FF8F40\">export</span><span style=\"color:#FF8F40\"> default</span><span style=\"color:#BFBDB6\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFB454\">  fetch</span><span style=\"color:#BFBDB6\">(</span><span style=\"color:#D2A6FF\">request</span><span style=\"color:#BFBDB6B3\">,</span><span style=\"color:#D2A6FF\"> env</span><span style=\"color:#BFBDB6\">) {</span></span>\n<span class=\"line\"><span style=\"color:#FF8F40\">    return</span><span style=\"color:#F29668\"> new</span><span style=\"color:#FFB454\"> Response</span><span style=\"color:#BFBDB6\">(</span><span style=\"color:#AAD94C\">'Hello World!'</span><span style=\"color:#BFBDB6\">)</span><span style=\"color:#BFBDB6B3\">;</span></span>\n<span class=\"line\"><span style=\"color:#BFBDB6\">  }</span></span>\n<span class=\"line\"><span style=\"color:#BFBDB6\">}</span></span>\n<span class=\"line\"></span></code></pre>"}}]}]}]]}],"\n",["$","p",null,{"children":["On the other hand, ",["$","strong",null,{"children":"stateful serverless provides an infinitely running process with storage"}],". An example implementation on Rivet Actors would look like this:"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"TypeScript"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$25"}}]}]}]]}],"\n",["$","$L21",null,{"level":3,"id":"primary-use-cases","children":"Primary Use Cases"}],"\n",["$","p",null,{"children":"The primary use cases of stateful serverless are:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Long-Running Processes"}],": Tasks that execute over extended periods or in multiple steps. For example, ",["$","strong",null,{"children":"AI Agents"}]," with ongoing conversations and stateful tool calls."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Stateful Services"}],": Applications where maintaining state across interactions is critical. For example, ",["$","strong",null,{"children":"Collaborative Apps"}]," with shared editing and automatic persistence."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Realtime Systems"}],": Applications requiring fast, in-memory state modifications or push updates to connected clients. For example, ",["$","strong",null,{"children":"Multiplayer Games"}]," with game rooms and player state."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Durability"}],": Processes that must survive crashes and restarts without data loss. For example, ",["$","strong",null,{"children":"Durable Execution"}]," workflows that continue after system restarts."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Horizontal Scalability"}],": Systems that need to scale by distributing load across many instances. For example, ",["$","strong",null,{"children":"Realtime Stream Processing"}]," for stateful event handling."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Local-First Architecture"}],": Systems that synchronize state between offline clients. For example, ",["$","strong",null,{"children":"Local-First Sync"}]," between devices."]}],"\n"]}],"\n",["$","p",null,{"children":["Read more about stateful serverless ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit","target":"_blank","children":"here"}],"."]}],"\n",["$","$L21",null,{"level":3,"id":"scope-of-this-proposal","children":"Scope Of This Proposal"}],"\n",["$","p",null,{"children":["For the purpose of this article, we'll assume ",["$","strong",null,{"children":"stateful serverless includes message passing & persistent storage"}],". This means we're not going to consider actor runtimes, such as Erlang/OTP, Akka, Orleans, Actix, and Swift Actors which do not include storage as a core component."]}],"\n",["$","$L21",null,{"level":2,"id":"why-should-i-care","children":"Why Should I Care?"}],"\n",["$","p",null,{"children":"Even if you've never heard of stateful serverless, you're probably using a site on a daily basis that already relies on stateful serverless with technologies like Cloudflare Durable Objects:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"CodePen"}],"\n",["$","li",null,{"children":"Liveblocks"}],"\n",["$","li",null,{"children":"Clerk"}],"\n",["$","li",null,{"children":"Wordware"}],"\n",["$","li",null,{"children":"Playroom"}],"\n",["$","li",null,{"children":"Tldraw"}],"\n"]}],"\n",["$","p",null,{"children":"Similarly, a significant portion of applications in general are powered by services with the actor pattern, which is a subset of what this standard would provide:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"WhatsApp (notoriously acquired for $19B with Erlang/OTP having only 35 engineers)"}],"\n",["$","li",null,{"children":"Discord"}],"\n",["$","li",null,{"children":"LinkedIn"}],"\n",["$","li",null,{"children":"Twitter/X"}],"\n",["$","li",null,{"children":"Pinterest"}],"\n",["$","li",null,{"children":"PayPal"}],"\n",["$","li",null,{"children":"Halo"}],"\n",["$","li",null,{"children":"FoundationDB (powering Apple, Snowflake, DataDog)"}],"\n",["$","li",null,{"children":"Many, many more"}],"\n"]}],"\n",["$","$L21",null,{"level":2,"id":"why-build-a-web-standard","children":"Why Build A Web Standard?"}],"\n",["$","$L21",null,{"level":3,"id":"customers-wary-of-vendor-lock","children":"Customers Wary Of Vendor-Lock"}],"\n",["$","p",null,{"children":["In 2025, customers are ",["$","strong",null,{"children":"wary of vendor-locking themselves to cloud services"}],". It's common for vendor-locked providers to either shut down, turn out to be unreliable, or price gouge contracts because their customers cannot leave."]}],"\n",["$","p",null,{"children":"Therefore, a standard allows all platforms offering stateful serverless to become a compelling offering. It's a rising tide: more competition means wider adoption and more customers."}],"\n",["$","p",null,{"children":["For example: though AWS is the leading cloud provider and pushes their own closed-source & non-standard software like DynamoDB & Lambda, ",["$","strong",null,{"children":"they still need to provide standard- and open-source-compatible software"}]," like Redis (ElastiCache), Cassandra (Keyspace), and Postgres/MySQL (Aurora) in order to remain an attractive offering for customers concerned about vendor lock."]}],"\n",["$","$L21",null,{"level":3,"id":"incentivize-more-providers","children":"Incentivize More Providers"}],"\n",["$","p",null,{"children":[["$","strong",null,{"children":"A standard would incentivize more cloud providers to enter the stateful serverless space."}]," Currently, only Cloudflare, Rivet, and RivetKit offer this capability, leaving a massive opportunity for other serverless cloud providers to adopt stateful serverless. With a common standard, more frameworks & developers can adopt this model."]}],"\n",["$","$L21",null,{"level":2,"id":"todays-stateful-serverless-implementations","children":"Today's Stateful Serverless Implementations"}],"\n",["$","$L21",null,{"level":3,"id":"cloudflare-durable-objects-the-most-popular-option","children":"Cloudflare Durable Objects: The Most Popular Option"}],"\n",["$","p",null,{"children":["Today, ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/","children":"Cloudflare Durable Objects"}]," are the incumbent of stateful serverless cloud providers."]}],"\n",["$","p",null,{"children":"A Durable Object looks something like this:"}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"TypeScript"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$26"}}]}]}]]}],"\n",["$","$L21",null,{"level":3,"id":"cloudflare-agents-framework-moving-beyond-durable-objects","children":"Cloudflare Agents Framework: Moving Beyond Durable Objects"}],"\n",["$","p",null,{"children":["The ",["$","$La",null,{"href":"https://developers.cloudflare.com/agents/","children":"Cloudflare Agents"}]," framework is for AI-powered agents to operate on the Durable Objects infrastructure."]}],"\n",["$","p",null,{"children":["As stated in their ",["$","$La",null,{"href":"https://blog.cloudflare.com/build-ai-agents-on-cloudflare/","children":"launch blog post"}],":"]}],"\n",["$","blockquote",null,{"children":["\n",["$","p",null,{"children":"Over the coming weeks, expect to see ... the ability to self-host agents on your own infrastructure."}],"\n"]}],"\n",["$","p",null,{"children":"Purely theorizing: a standard for stateful serverless might provide the foundation for this."}],"\n",["$","$L21",null,{"level":3,"id":"rivet-open-source-serverless-infrastructure","children":"Rivet: Open-Source Serverless Infrastructure"}],"\n",["$","p",null,{"children":"I'm the founder of Rivet and have a vested interest in seeing stateful serverless become a standard. Rivet provides an open-source stateful serverless platform that can be easily self-hosted."}],"\n",["$","p",null,{"children":["We also provide a handful of features in our runtime that don't make sense to be part of a standard, since the best W3C standards build on existing web standards: ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/containers","children":"Docker containers for non-JavaScript applications"}],", ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/networking","children":"HTTP, UDP, and TCP support"}],", ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/durability","children":"advanced lifecycle management"}],", ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/api/actors/create","children":"actor tagging"}]," for advanced multi-tenant applications, ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/api/actors/upgrade-all","children":"advanced control over actor upgrades"}]," for companies with specific use cases, ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/api/regions/list","children":"fine-grained control over where your actor is running"}],", and a developer-friendly REST API for managing Rivet Actors."]}],"\n",["$","p",null,{"children":["We encourage developers building on Rivet to use ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit","children":"RivetKit"}],". However, we also provide a ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/actors","children":"low-level API"}]," for defining actors:"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"TypeScript"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$27"}}]}]}]]}],"\n",["$","p",null,{"children":["Unlike Durable Objects, Rivet's core API design opts to lean into Unix-like patterns such as using ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SIGINT"}}]," signals, leveraging ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"process.exit"}}],", and using environment variables."]}],"\n",["$","p",null,{"children":["Check out the ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivet","children":"source code on GitHub"}],"."]}],"\n",["$","$L21",null,{"level":3,"id":"rivet-kit-framework-stateful-serverless-on-any-cloud","children":"RivetKit Framework: Stateful Serverless On Any Cloud"}],"\n",["$","p",null,{"children":["At Rivet, we also manage a framework called ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit","children":"RivetKit"}]," that provides a Durable Object-like experience on any cloud that provides ",["$","em",null,{"children":"stateless"}]," serverless."]}],"\n",["$","p",null,{"children":"A Rivet Actor definition looks something like this:"}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"TypeScript"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$28"}}]}]}]]}],"\n",["$","p",null,{"children":["Under the hood is where it gets interesting: RivetKit is intended to support as many platforms as possible and is ",["$","strong",null,{"children":"completely abstracted with drivers"}],". By doing so, RivetKit supports Rivet, Cloudflare Durable Objects, Bun, Node.js. Vercel, Supabase, Deno, and Lambda are coming in the near future."]}],"\n",["$","p",null,{"children":["These drivers provide a ",["$","strong",null,{"children":"peek at what a standard might require"}],", since they're already abstracted to be platform-agnostic:"]}],"\n",["$","p",null,{"children":[["$","strong",null,{"children":["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit/blob/a9a5cfa5b91aff73889bbbee965d52221f89c2c7/packages/actor-core/src/actor/driver.ts#L12","children":"ActorDriver"}]}],": Manages actor state, lifecycle, and persistence"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"TypeScript"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$29"}}]}]}]]}],"\n",["$","p",null,{"children":[["$","strong",null,{"children":["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit/blob/a9a5cfa5b91aff73889bbbee965d52221f89c2c7/packages/actor-core/src/manager/driver.ts#L5","children":"ManagerDriver"}]}],": Handles actor discovery, routing, and scaling"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"TypeScript"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$2a"}}]}]}]]}],"\n",["$","p",null,{"children":["There is also a ",["$","strong",null,{"children":["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit/blob/a9a5cfa5b91aff73889bbbee965d52221f89c2c7/packages/actor-core/src/topologies/coordinate/driver.ts#L29","children":"CoordinatedDriver"}]}]," that provides support for implementing actors over peer-to-peer for platforms that don't natively support stateful serverless. This would not apply to an actor standard."]}],"\n",["$","p",null,{"children":["Read more about ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit/tree/main/docs","children":"building your own RivetKit drivers"}],"."]}],"\n",["$","p",null,{"children":["Check out the ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivet","children":"source code on GitHub"}],"."]}],"\n",["$","$L21",null,{"level":3,"id":"other-actor-runtimes-the-precursor-to-stateful-serverless","children":"Other Actor Runtimes: The Precursor To Stateful Serverless"}],"\n",["$","p",null,{"children":["Runtimes like OTP (i.e. Erlang & Elixir & Gleam), Akka, Orleans, Actix, and Swift Actors all ",["$","strong",null,{"children":"lack built-in support for persisted state"}],". There are libraries that provide state for actors, but their models are significantly different than what we'll consider here. Additionally, we're focused on JavaScript since that's primary language for web standards."]}],"\n",["$","$L21",null,{"level":2,"id":"specification-goals","children":"Specification Goals"}],"\n",["$","p",null,{"children":["For the purpose of this exploration, I'm going to ",["$","strong",null,{"children":"recommend sticking with web standards"}],", which are managed by the ",["$","$La",null,{"href":"https://www.w3.org/","target":"_blank","children":"W3C"}]," organization. Doing so allows us to ",["$","strong",null,{"children":"build on top of existing successful web standards"}],", such as ",["$","$La",null,{"href":"https://wintertc.org/","target":"_blank","children":"WinterTC"}]," and the ",["$","$La",null,{"href":"https://fetch.spec.whatwg.org/#request-class","target":"_blank","children":"fetch specification"}]," that are currently offered across almost all stateless serverless platforms already."]}],"\n",["$","p",null,{"children":"The goals of this proposal are:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Simplicity Of Implementation"}],": Implementing standards correctly is difficult, expensive, and highly error prone. Simpler is better."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Simplicity Of Usage"}],": Stateful serverless is not a concept that is easy for many developers to understand. Prefer simplicity vs advanced features to keep the API as simple as possible for greater adoption."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Build For Frameworks"}],": ",["$","$La",null,{"href":"https://hono.dev/","target":"_blank","children":"Hono"}]," and ",["$","$La",null,{"href":"https://itty.dev/itty-router/","target":"_blank","children":"itty-router"}]," already proved that frameworks are almost always used with serverless runtimes. Stateful serverless is already used widely with ",["$","$La",null,{"href":"https://www.partykit.io/","target":"_blank","children":"PartyKit"}],", ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit","target":"_blank","children":"RivetKit"}],", ",["$","$La",null,{"href":"https://developers.cloudflare.com/agents/","target":"_blank","children":"Agents"}],", and misc tools like ",["$","$La",null,{"href":"https://tinybase.org/","target":"_blank","children":"TinyBase"}],". If possible, leave functionality up to frameworks to implement."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Built On Existing Web Development Paradigms"}],": Stateful serverless is very similar to ",["$","$La",null,{"href":"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API","target":"_blank","children":"Web Workers"}],". Where possible refer to Web Workers to see what works well."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Focus On Stateful Workloads, Not Actors"}],": I love building distributed systems with the actor model, but actors require extra consideration around message handling, concurrency, and backpressure."]}],"\n"]}],"\n",["$","$L21",null,{"level":3,"id":"classes-vs-functions","children":"Classes vs Functions"}],"\n",["$","p",null,{"children":["Durable Objects provides a class-based approach to stateful serverless (e.g. ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"class X extends DurableObject { ... }"}}],"). Rivet provides a functional approach (e.g. ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"export default { start () { ... } }"}}],")."]}],"\n",["$","p",null,{"children":"Sticking to the WinterTC ESM-style makes sense. Additionally, it's similar to how Web Workers are already defined."}],"\n",["$","$L21",null,{"level":3,"id":"alternative-1-fetch-based-communication","children":"Alternative #1: Fetch-Based Communication"}],"\n",["$","p",null,{"children":["Both Rivet & Durable Objects use WinterTC-like ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"fetch"}}]," handlers to accept requests on Durable Objects/Rivet Actors. An alternative spec would opt to use ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"fetch"}}]," handlers instead of a brand new definition. This is similar to what WinterTC is attempting to do: take existing patterns and standardize them as opposed to implementing a new standard."]}],"\n",["$","p",null,{"children":"This standard makes an intentional decision to define a simpler, more portable API than provide compatibility with only 2 existing implementations."}],"\n",["$","$L21",null,{"level":3,"id":"alternative-2-a-cgi-like-standard","children":"Alternative #2: A CGI-Like Standard"}],"\n",["$","p",null,{"children":["An alternative implementation is to consider something along the lines of ",["$","$La",null,{"href":"https://en.wikipedia.org/wiki/Common_Gateway_Interface","children":"CGI"}]," which provides a more Unix-like implementation of serverless functions & supports multiple languages. However, the industry has consolidated behind JavaScript & WebAssembly for serverless clouds because of the developer & cost efficiency. Additionally, CGI lacks many of the modern features that W3C specifications take into account for web standards. (Originally proposed by ",["$","$La",null,{"href":"https://x.com/mitsuhiko","children":"Armin Ronacher"}],".)"]}],"\n",["$","$L21",null,{"level":2,"id":"drawing-inspiration-from-shared-worker","children":["Drawing Inspiration From ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]]}],"\n",["$","$L20",null,{"src":{"src":"/_next/static/media/sharedworker.1a0b47fb.png","height":934,"width":1258,"blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAGCAMAAADJ2y/JAAAACVBMVEUfGxsTExMqICDPjCNjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIklEQVR4nCWJgQkAAAyCtP+PHrUgC8QGZJsA7aMMU1btiAcEFgAnkkrSDQAAAABJRU5ErkJggg==","blurWidth":8,"blurHeight":6},"alt":"Overview of SharedWorker arch"}],"\n",["$","p",null,{"children":["Though designed for client-side concurrency, ",["$","$La",null,{"href":"https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]}]," offers a programming model that closely resembles what we're discussing for server-side actors. The ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]," API already has many of the core concepts needed for a stateful serverless standard:"]}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Multi-Tenant"}],": ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]," can serve multiple browser tabs, similar to how Durable Objects and Rivet Actors serves multiple clients"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Isolated Execution Context"}],": Each worker runs in its own isolated environment"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Message-Based Communication"}],": Workers communicate via structured message passing."]}],"\n"]}],"\n",["$","p",null,{"children":["You can think of a ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," like a ",["$","$La",null,{"href":"https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]}]," that is:"]}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"In the cloud"}],"\n",["$","li",null,{"children":"Includes persistent storage"}],"\n",["$","li",null,{"children":"Runs forever"}],"\n"]}],"\n",["$","p",null,{"children":"Here's a comparison of how Web Workers operate in the browser:"}],"\n",["$","div",null,{"className":"code-group group my-4 rounded-md border pt-2","data-code-group":true,"children":["$","$L2b",null,{"defaultValue":"SharedWorker","children":[["$","div",null,{"className":"flex gap-1 border-b pr-2","children":[["$","$L24",null,{"className":"w-full","viewportProps":{"className":"[&>div]:!table"},"children":["$","$L2c",null,{"className":"border-b-0","children":[["$","$L2d","SharedWorker/.0",{"value":"SharedWorker","children":"SharedWorker"}],["$","$L2d","DurableObject/.1",{"value":"DurableObject","children":"DurableObject"}],["$","$L2d","RivetKit/.2",{"value":"RivetKit","children":"RivetKit"}]]}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5 text-foreground","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],[["$","$L2e","SharedWorker/.0",{"value":"SharedWorker","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$2f"}}]}]}]]}]}],["$","$L2e","DurableObject/.1",{"value":"DurableObject","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$30"}}]}]}]]}]}],["$","$L2e","RivetKit/.2",{"value":"RivetKit","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$31"}}]}]}]]}]}]]]}]}],"\n",["$","p",null,{"children":["The ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"onmessage"}}]," handler is very similar to the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"fetch"}}]," handler in a Durable Object or an ",["$","$La",null,{"href":"/docs/actors/actions","children":"Action"}]," in RivetKit."]}],"\n",["$","p",null,{"children":"The key differences are:"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Persistence"}],": Web Workers lose state when the page refreshes, while ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s maintain state between invocations."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Network Access"}],": Stateful serverless inherently supports network requests via fetch/WebSockets."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Lifecycle Management"}],": ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s have advanced wake/sleep and scheduling capabilities."]}],"\n"]}],"\n",["$","$L21",null,{"level":2,"id":"introducing-serverless-worker","children":["Introducing ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]]}],"\n",["$","$L20",null,{"src":{"src":"/_next/static/media/serverlessworker.224d7149.png","height":1060,"width":1916,"blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAECAMAAACEE47CAAAACVBMVEUTExMcGRkmHx/6SzHQAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAH0lEQVR4nCXJsQ0AAAyDMOD/oyulLB6AJShZ4sg/5AEBxAAb6hcIGwAAAABJRU5ErkJggg==","blurWidth":8,"blurHeight":4},"alt":"Overview of ServerlessWorker arch"}],"\n",["$","p",null,{"children":[["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," is an API similar to the existing Web Workers API that provides the core functionality of both Cloudflare Durable Objects and Rivet Actors:"]}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Multi-Tenant"}],": ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," can serve multiple clients at the same time in realtime."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Message-Based Communication"}],": Communicates via ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"postMessage"}}],"."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Persistent"}],": ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorkers"}}]," run forever. They cannot crash. Implementations of the standard can optionally make workers sleep when there is no activity."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Storage"}],": ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorkers"}}]," can store data that persists for ever. Implementations of the standard should design this data to be stored next to compute for optimal read-write performance."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Isolated Execution Context"}],": Each worker runs in its own isolated environment"]}],"\n"]}],"\n",["$","$L21",null,{"level":3,"id":"creating-initializing-and-addressing-serverless-workers","children":["Creating, Initializing, & Addressing ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s"]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Rivet & RivetKit"}]}],"\n",["$","p",null,{"children":"Rivet and RivetKit provide a tagging system for organizing actors. This allows you to build more manageable multi-tenant applications with complex requirements. For example:"}],"\n",["$","p",null,{"children":["Rivet allows you to create actors with the ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/api/actors/create","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"actors.create"}}]}]," endpoint. The API accepts environment variables to configure how the actor behaves."]}],"\n",["$","p",null,{"children":["RivetKit allows passing tags to ",["$","$La",null,{"href":"https://github.com/rivet-gg/rivetkit","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"client.get({ /* tags */ })"}}]}]," to get or create an actor, but does not provide environment variables. You can also use the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"client.create"}}]," method to create a fresh actor. Actors can read their own tags to configure behavior accordingly:"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"TypeScript"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$32"}}]}]}]]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Durable Objects"}]}],"\n",["$","p",null,{"children":["To create a Durable Object on Cloudflare, you call the ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/api/namespace/#newuniqueid","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"newUniqueId"}}]}]," method. This will give you a unique ID for a new Durable Object."]}],"\n",["$","p",null,{"children":["Cloudflare also provides a ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/api/namespace/#idfromname","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"idFromName"}}]}]," method to get the ID of an Durable Object from an arbitrary string. This ID is then used to resolve a Durable Object stub that you can send requests to. For example:"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"TypeScript"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$33"}}]}]}]]}],"\n",["$","p",null,{"children":["Cloudflare Durable Objects is desigend to have no concept of \"created\" or \"destroyed.\" The initial state can be configured by sending an RPC to the DO upon creation. This implementation of not having an input state for a ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," is simpler and leaves the functionality up to the framework; instead all a ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," has a unique ID that developers can send messages to."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":["Current Implementation: ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]]}]}],"\n",["$","p",null,{"children":[["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]," accepts a ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"name"}}]," parameter, for example: ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"new SharedWorker(&quot;./sharedWorker.js&quot;, "}}],"chat-room-random",["$","code",null,{"dangerouslySetInnerHTML":{"__html":")"}}],". This is akin to calling ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"idFromName"}}]," for Durable Objects. Passing no name will give you the same worker."]}],"\n",["$","p",null,{"children":["The ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"name"}}]," is accessible in the global scope of the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}],"."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Proposal"}]}],"\n",["$","p",null,{"children":["Constructing a ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," object will mimic the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]," API. Passing a ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"name"}}]," parameter to the second constructor argument will let you address a given ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],". Passing no arguments will give you the same worker."]}],"\n",["$","p",null,{"children":["The ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"name"}}]," is accessible in the global scope of the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"."]}],"\n",["$","p",null,{"children":"An example API could look like:"}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"server.js"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$34"}}]}]}]]}],"\n",["$","p",null,{"children":"To resolve with a custom name:"}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"server.js"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$35"}}]}]}]]}],"\n",["$","p",null,{"children":"To access the name in the worker:"}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"worker.js"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"<pre class=\"shiki ayu-dark\" style=\"background-color:#0c0a09;color:#bfbdb6\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#ACB6BF8C;font-style:italic\">// Worker code can access its name</span></span>\n<span class=\"line\"><span style=\"color:#BFBDB6\">console</span><span style=\"color:#F29668\">.</span><span style=\"color:#FFB454\">log</span><span style=\"color:#BFBDB6\">(self</span><span style=\"color:#F29668\">.</span><span style=\"color:#BFBDB6\">name)</span><span style=\"color:#BFBDB6B3\">;</span></span>\n<span class=\"line\"></span></code></pre>"}}]}]}]]}],"\n",["$","$L21",null,{"level":3,"id":"terminating-serverless-workers","children":["Terminating ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s"]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Rivet"}]}],"\n",["$","p",null,{"children":["Rivet provides two ways to destroy an actor: use ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"process.exit(0)"}}]," or call ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/api/actors/destroy","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"actors.destroy"}}]}]," from the API."]}],"\n",["$","p",null,{"children":["RivetKit will provide a ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ctx.shutdown"}}]," method that delegates to ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ActorDriver"}}],", though is not currently implemented."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Durable Objects"}]}],"\n",["$","p",null,{"children":["Cloudflare's approach to destroying Durable Objects is somewhat unique. There is no concept of \"created\" or \"destroyed\" actor. To reset an actor, you clear the storage with ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/api/storage-api/#deleteall","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"deleteAll()"}}]}],". While unintuitive, this leaves it up to the framework to implement."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":["Current Implementation: ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]]}]}],"\n",["$","p",null,{"children":["Web Workers' ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]," is automatically destroyed when all ports are closed. This is not relevant to stateful serverless."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Proposal"}]}],"\n",["$","p",null,{"children":["Add a ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"terminate"}}]," method on the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," itself, leave it up to the frameworks to implement destroying. For example:"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"worker.js"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"<pre class=\"shiki ayu-dark\" style=\"background-color:#0c0a09;color:#bfbdb6\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#FF8F40\">export</span><span style=\"color:#FF8F40\"> default</span><span style=\"color:#BFBDB6\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFB454\">\tconnect</span><span style=\"color:#BFBDB6\">(</span><span style=\"color:#D2A6FF\">event</span><span style=\"color:#BFBDB6\">) {</span></span>\n<span class=\"line\"><span style=\"color:#BFBDB6\">\t\tself</span><span style=\"color:#F29668\">.</span><span style=\"color:#FFB454\">terminate</span><span style=\"color:#BFBDB6\">()</span><span style=\"color:#BFBDB6B3\">;</span></span>\n<span class=\"line\"><span style=\"color:#BFBDB6\">\t}</span></span>\n<span class=\"line\"><span style=\"color:#BFBDB6\">}</span></span>\n<span class=\"line\"></span></code></pre>"}}]}]}]]}],"\n",["$","$L21",null,{"level":3,"id":"connections-and-messages","children":"Connections & Messages"}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Rivet"}]}],"\n",["$","p",null,{"children":"Both Rivet Actors & Durable Objects provide a way to serve requests to actors based on web standards."}],"\n",["$","p",null,{"children":["Rivet provides flexible networking infrastructure, including ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/networking","children":"UDP, TCP, and host networking"}],". To remain widely compatible, Rivet relies on the Deno implementation of the fetch handler with ",["$","$La",null,{"href":"https://docs.deno.com/api/deno/~/Deno.serve","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"Deno.serve"}}]}],"."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Cloudflare"}]}],"\n",["$","p",null,{"children":["Durable Objects supports a similar ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/best-practices/create-durable-object-stubs-and-send-requests/#invoking-the-fetch-handler","children":"fetch handler"}],", but also provides non-standard features like ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/best-practices/create-durable-object-stubs-and-send-requests/","children":"RPC"}],"."]}],"\n",["$","p",null,{"children":["Both rely on different implementations for WebSockets, though this handled gracefully by libraries like ",["$","$La",null,{"href":"https://hono.dev/docs/helpers/websocket","children":"Hono's WebSocket helper"}],"."]}],"\n",["$","p",null,{"children":["There is a WinterTC proposal for a ",["$","$La",null,{"href":"https://github.com/wintercg/proposal-sockets-api","children":"Sockets API"}],", though I'm going to consider this out of the scope of this article since ",["$","$La",null,{"href":"https://developers.cloudflare.com/workers/runtime-apis/tcp-sockets/","children":"Cloudflare's implementation"}]," is not currently supported on Durable Objects."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":["Current Implementation: ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]]}]}],"\n",["$","p",null,{"children":["However, Web Worker (",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}],") opts for using ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"onconnect"}}]," & ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"port.onmessage"}}]," like this:"]}],"\n",["$","div",null,{"className":"code-group group my-4 rounded-md border pt-2","data-code-group":true,"children":["$","$L2b",null,{"defaultValue":"main.js","children":[["$","div",null,{"className":"flex gap-1 border-b pr-2","children":[["$","$L24",null,{"className":"w-full","viewportProps":{"className":"[&>div]:!table"},"children":["$","$L2c",null,{"className":"border-b-0","children":[["$","$L2d","main.js/.0",{"value":"main.js","children":"main.js"}],["$","$L2d","sharedWorker.js/.1",{"value":"sharedWorker.js","children":"sharedWorker.js"}]]}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5 text-foreground","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],[["$","$L2e","main.js/.0",{"value":"main.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$36"}}]}]}]]}]}],["$","$L2e","sharedWorker.js/.1",{"value":"sharedWorker.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$37"}}]}]}]]}]}]]]}]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Proposal"}]}],"\n",["$","p",null,{"children":["This could go two ways: lean into the existing ",["$","$La",null,{"href":"https://github.com/wintercg/proposal-functions-api/tree/main","children":"WinterTC for ESM-style handlers"}]," like Durable Objects and Rivet or opt for a simpler & portable interface like Web Workers."]}],"\n",["$","p",null,{"children":["In my opinion, request/response should use ESM-style exports with the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]," interface. This allows the simplicity of request/response & also enables full bidirectional streaming -- like a WebSocket but without the overhead."]}],"\n",["$","div",null,{"className":"code-group group my-4 rounded-md border pt-2","data-code-group":true,"children":["$","$L2b",null,{"defaultValue":"server.js","children":[["$","div",null,{"className":"flex gap-1 border-b pr-2","children":[["$","$L24",null,{"className":"w-full","viewportProps":{"className":"[&>div]:!table"},"children":["$","$L2c",null,{"className":"border-b-0","children":[["$","$L2d","server.js/.0",{"value":"server.js","children":"server.js"}],["$","$L2d","server.js/.1",{"value":"server.js","children":"server.js"}]]}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5 text-foreground","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],[["$","$L2e","server.js/.0",{"value":"server.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$38"}}]}]}]]}]}],["$","$L2e","server.js/.1",{"value":"server.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$39"}}]}]}]]}]}]]]}]}],"\n",["$","p",null,{"children":"Coincidentally, this also feels very similar to socket.io whose API has proven itself as flexible & easy to understand."}],"\n",["$","$L21",null,{"level":3,"id":"storage","children":"Storage"}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementations: Rivet & Durable Objects & Deno"}]}],"\n",["$","p",null,{"children":"Both Rivet and Durable Objects support a raw KV interface to access data stored on the actor itself."}],"\n",["$","p",null,{"children":["While not specific to actors, Deno attempts to implement an ",["$","$La",null,{"href":"https://docs.deno.com/api/deno/~/Deno.Kv","children":"abstract KV interface"}],". However, this API is very opinionated to Deno Deploy and is by no means compatible across multiple clouds."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Why KV"}]}],"\n",["$","p",null,{"children":["Anything more (especially ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"IndexedDB"}}],") is too complicated to expect cloud providers to implement correctly. ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"localStorage"}}]," has proven itself a simple & reliable key-value store that's lasted the test of time."]}],"\n",["$","p",null,{"children":["Frameworks can implement more advanced logic on top of key-value stores, just as they've done in the browser with ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"localStorage"}}],"."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Async"}]}],"\n",["$","p",null,{"children":["Regardless of what API this results in, it should be asynchronous. Cloudflare has gone as far as removing async code for their SQLite interface because they state it's fast enough to not require an async context; the KV API could likely be made as simple as something like the browser's ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"localStorage"}}]," by making each key a synchronous get. However, platforms all implement KV differently, so this may not make sense if attempting to provide maximum compatibility. Additionally, it would be impossible for compatibility layers to implement a KV API with an external medium if that medum requires an async operation to communicate with."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Strings vs Structured Clone"}]}],"\n",["$","p",null,{"children":[["$","code",null,{"dangerouslySetInnerHTML":{"__html":"localStorage"}}]," currently only supports strings, which is what most developers are used to."]}],"\n",["$","p",null,{"children":["However, both Rivet & Cloudflare Workers support natively storing data types that implement ",["$","$La",null,{"href":"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm","children":"structured cloning"}]," which allows storing many types of data in a compact V8-compatible binary interface with high-performance serialization & deserialization."]}],"\n",["$","p",null,{"children":["If structured cloning was a protocol defined earlier, ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"localStorage"}}]," would likely support it natively. Whatever storage mechanism is chosen should support structured cloning."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"A Word On Complexity"}]}],"\n",["$","p",null,{"children":"W3C has a history of inventing incredibly complicated standards for storage that are both (a) hard to understand as developers and (b) difficult to implement as a platform."}],"\n",["$","p",null,{"children":["If you know how to use the ",["$","$La",null,{"href":"https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API","children":"IndexedDB"}]," API from memory, I'm impressed."]}],"\n",["$","p",null,{"children":["Additionally, ",["$","$La",null,{"href":"https://developer.chrome.com/blog/deprecating-web-sql","children":"Web SQL"}]," was an alternative standard that was deprecated because of its complexity."]}],"\n",["$","p",null,{"children":["Whatever the storage mechanism for ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s is, ",["$","strong",null,{"children":"keep it simple, easy to implement, and easy to understand"}],". Frameworks can always do the heavy lifting for you."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Concurrency & Input/Output Gates"}]}],"\n",["$","p",null,{"children":"Concurrency is difficult to implement correctly across multiple platforms."}],"\n",["$","p",null,{"children":["Cloudflare Durable Objects intelligently prevents common storage race conditions on Durable Objects without transactions through a mechanism called ",["$","em",null,{"children":"input/output gates"}]," detailed ",["$","$La",null,{"href":"https://blog.cloudflare.com/durable-objects-easy-fast-correct-choose-three/#our-answer-make-it-automatic","children":"here"}],". This can be disabled with ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ctx.storage.get(/* key*/, { allowConcurrency: true })"}}],". Doing so will make the KV work like naive get/set without any extra functionality."]}],"\n",["$","p",null,{"children":"This is a controversial opinion, but I think that this behavior should be disabled by default and not part of a specification for a few reasons:"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":["Durable Object users almost never read from storage at runtime. ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"storage.get"}}]," is called in the constructor and ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"storage.put"}}]," is called when changed."]}],"\n",["$","li",null,{"children":"This behavior can be implemented at the framework level."}],"\n",["$","li",null,{"children":"This behavior is almost certainly going to be incorrectly implemented by vendors."}],"\n",["$","li",null,{"children":["Input/output gates do not work with WebSocket on Durable Objects already (please correct me if I'm wrong) and most developers aren't accounting for this. ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"postMessage"}}]," and ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"onmessage"}}]," are closer to the Durable Object WebSocket behavior than the RPC behavior."]}],"\n"]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Keeping Scope Small"}]}],"\n",["$","p",null,{"children":["For the purpose of building a broader picture of what ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," might look like in practice, I'm going to assume that storage is going to be part of this specification. However, I think it makes more sense to either (a) find an existing mature spec to use for storage or (b) define a separate spec that can work in contexts outside of ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Proposal"}]}],"\n",["$","p",null,{"children":"Provide a dead simple async structured clone-based KV API and let the platforms provide extra configs for concurrency. For example:"}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"worker.js"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$3a"}}]}]}]]}],"\n",["$","$L21",null,{"level":3,"id":"scheduling","children":"Scheduling"}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementations"}]}],"\n",["$","p",null,{"children":["A core part of ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s is to be able to run a function at an arbitrary timestamp."]}],"\n",["$","p",null,{"children":["Cloudflare provides a simple ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"setAlarm"}}]," API that has a single alarm. If you already have an alarm, it will override that alarm. I like this API since it's significantly simpler than ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"setInterval"}}]," and ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"setTimeout"}}]," and lets frameworks provide more advanced APIs, such as CRONs."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Proposal"}]}],"\n",["$","p",null,{"children":["Provide an API similar to Cloudflare's ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/api/storage-api/#setalarm","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"setAlarm"}}]}],". For example:"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"worker.js"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$3b"}}]}]}]]}],"\n",["$","$L21",null,{"level":3,"id":"sleeping-and-upgrading-and-host-migrations","children":"Sleeping & Upgrading & Host Migrations"}],"\n",["$","p",null,{"children":["A core advantage of ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s to something like ",["$","$La",null,{"href":"https://kubernetes.io/docs/concepts/workloads/controllers/job/","children":"Kubernetes jobs"}]," or other container-based stateful workloads: ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s can ",["$","strong",null,{"children":"automatically sleep when there are no active operations"}]," and ",["$","strong",null,{"children":"wake upon either fetch or alarm"}],"."]}],"\n",["$","p",null,{"children":["However, ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," has to address specific edge cases when there are tasks that need to run in the background before being put to sleep."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Rivet"}]}],"\n",["$","p",null,{"children":["Rivet mimics Unix behavior by sending a ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SIGINT"}}]," signal to the process when it plans to go to sleep. Your application is given time to clean up any work and restart gracefully when it's ready. This provides compatibility for a wide range of existing frameworks that implement the Node.js or Deno shutdown handler."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Durable Objects"}]}],"\n",["$","p",null,{"children":["Durable Objects provides ",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/api/state/#waituntil","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"waitUntil"}}]}],". My understanding is this is effectively a noop since (",["$","$La",null,{"href":"https://developers.cloudflare.com/durable-objects/api/state/#waituntil","children":"see note"}],"). However, I like the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"waitUntil"}}]," API since it provides a JavaScript-y way of forcing the actor to stay awake."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Proposal"}]}],"\n",["$","p",null,{"children":["Provide an API similar to Durable Objects ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"waitUntil"}}],". The provider can decide the maximum duration for this function. For example:"]}],"\n",["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[["$","div",null,{"className":"text-foreground flex items-center justify-between gap-2 border-b p-2 text-xs","children":[["$","div",null,{"className":"text-muted-foreground flex items-center gap-1","children":["$","div",null,{"ref":"$undefined","className":"inline-flex items-center tracking-normal rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-nowrap max-w-full overflow-hidden truncate text-foreground","children":"worker.js"}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"<pre class=\"shiki ayu-dark\" style=\"background-color:#0c0a09;color:#bfbdb6\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#FF8F40\">async</span><span style=\"color:#FF8F40\"> function</span><span style=\"color:#FFB454\"> doSomethingAsync</span><span style=\"color:#BFBDB6\">() {</span></span>\n<span class=\"line\"><span style=\"color:#ACB6BF8C;font-style:italic\">\t// ...</span></span>\n<span class=\"line\"><span style=\"color:#BFBDB6\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#FFB454\">waitUntil</span><span style=\"color:#BFBDB6\">(</span><span style=\"color:#FFB454\">doSomethingAsync</span><span style=\"color:#BFBDB6\">())</span><span style=\"color:#BFBDB6B3\">;</span></span>\n<span class=\"line\"></span></code></pre>"}}]}]}]]}],"\n",["$","$L21",null,{"level":3,"id":"handling-backpressure","children":"Handling Backpressure"}],"\n",["$","p",null,{"children":"Backpressure is a core problem in every distributed system and should always be handled carefully by developers to handle load gracefully."}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Rivet"}]}],"\n",["$","p",null,{"children":"Rivet provides low-level primitives to the developer, so it's up to the developer to handle backpressure accordingly. An overloaded actor without any special backpressure handling will saturate the CPU."}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Current Implementation: Durable Objects"}]}],"\n",["$","p",null,{"children":["Durable Objects throw an error with the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":".overloaded"}}]," property set to ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"true"}}]," when making requests to a Durable Object that cannot accept more requests."]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Proposal"}]}],"\n",["$","p",null,{"children":"Define an error type that can be used by developers to handle backpressure gracefully."}],"\n",["$","$L21",null,{"level":3,"id":"security-model","children":"Security Model"}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Proposal"}]}],"\n",["$","p",null,{"children":[["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," should rely on the existing work in WinterTC. They are secured via these attributes:"]}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Fetch Handler"}],": Stateful ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s are only accessible through the stateless serverless fetch handler defined in WinterTC. This creates a protected gateway where all requests are authenticated and authorized before reaching any ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Isolation Boundaries"}],": Each ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," runs in its own isolated environment, similar to Web Workers, preventing cross-worker data access without explicit communication channels."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"No Direct Network Access"}],": ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s cannot be directly addressed from the public internet. All communication flows through the fetch handler, which can implement rate limiting, validation, and other security controls."]}],"\n"]}],"\n",["$","p",null,{"children":["The downside of relying on the fetch handler is that it may restrict who can implement ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],". For example, there are many container orchestration platforms that may be able to implement the worker part of ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],", but cannot implement the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"fetch"}}]," handler. I don't think this is an issue, since including these technologies that don't already comply to WinterTC would make it too broad to be effective."]}],"\n",["$","$L21",null,{"level":3,"id":"out-of-scope","children":"Out Of Scope"}],"\n",["$","p",null,{"children":"Items out of the scope for this spec:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Locality"}],": Cloudflare & Rivet both have notions of where actors run, though the default is to run nearest where the request is coming from. This will likely end up as a platform-specific feature when constructing ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Supervisors"}],": Traditional actor runtimes use \"supervisors\" to automatically restart crashed actors. ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," cannot crash, and instead will automatically log and disregard thrown errors -- similar to service workers."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"SQLite Storage"}],": Many serious use cases of Durable Objects rely on SQLite. This is out of the scope for this web standard."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Versioning"}],": Cloudflare and Rivet each have significantly different ways of implementing versioning. Rivet is more like AWS AMI, while Cloudflare uses a simpler but less flexible version history."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Upgrades & Rolling Deploys"}],": Leave it up to the platform to decide what code is running. Under the hood, the Rivet implementation of this standard would automatically call ",["$","$La",null,{"href":"https://rivet.gg/docs/cloud/api/actors/upgrade","children":["$","code",null,{"dangerouslySetInnerHTML":{"__html":"actors.upgrade"}}]}]]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Logging"}],": Leave this up to the platform to decide how to ship logs."]}],"\n"]}],"\n",["$","$L21",null,{"level":2,"id":"full-examples","children":"Full Examples"}],"\n",["$","$L21",null,{"level":3,"id":"rate-limiter","children":"Rate Limiter"}],"\n",["$","p",null,{"children":"This example demonstrates building a rate limit."}],"\n",["$","div",null,{"className":"code-group group my-4 rounded-md border pt-2","data-code-group":true,"children":["$","$L2b",null,{"defaultValue":"rateLimiter.js","children":[["$","div",null,{"className":"flex gap-1 border-b pr-2","children":[["$","$L24",null,{"className":"w-full","viewportProps":{"className":"[&>div]:!table"},"children":["$","$L2c",null,{"className":"border-b-0","children":[["$","$L2d","rateLimiter.js/.0",{"value":"rateLimiter.js","children":"rateLimiter.js"}],["$","$L2d","server.js/.1",{"value":"server.js","children":"server.js"}]]}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5 text-foreground","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],[["$","$L2e","rateLimiter.js/.0",{"value":"rateLimiter.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$3c"}}]}]}]]}]}],["$","$L2e","server.js/.1",{"value":"server.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$3d"}}]}]}]]}]}]]]}]}],"\n",["$","$L21",null,{"level":3,"id":"pub-sub-server","children":"Pub/Sub Server"}],"\n",["$","p",null,{"children":"This example demonstrates a simple pub/sub system where each topic is its own serverless worker with connected clients."}],"\n",["$","div",null,{"className":"code-group group my-4 rounded-md border pt-2","data-code-group":true,"children":["$","$L2b",null,{"defaultValue":"topicWorker.js","children":[["$","div",null,{"className":"flex gap-1 border-b pr-2","children":[["$","$L24",null,{"className":"w-full","viewportProps":{"className":"[&>div]:!table"},"children":["$","$L2c",null,{"className":"border-b-0","children":[["$","$L2d","topicWorker.js/.0",{"value":"topicWorker.js","children":"topicWorker.js"}],["$","$L2d","server.js/.1",{"value":"server.js","children":"server.js"}],["$","$L2d","client.js/.2",{"value":"client.js","children":"client.js"}]]}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5 text-foreground","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],[["$","$L2e","topicWorker.js/.0",{"value":"topicWorker.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$3e"}}]}]}]]}]}],["$","$L2e","server.js/.1",{"value":"server.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$3f"}}]}]}]]}]}],["$","$L2e","client.js/.2",{"value":"client.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$40"}}]}]}]]}]}]]]}]}],"\n",["$","$L21",null,{"level":3,"id":"simple-chat-room","children":"Simple Chat Room"}],"\n",["$","p",null,{"children":"This example demonstrates a simple chat room implementation with message persistence."}],"\n",["$","div",null,{"className":"code-group group my-4 rounded-md border pt-2","data-code-group":true,"children":["$","$L2b",null,{"defaultValue":"chatRoom.js","children":[["$","div",null,{"className":"flex gap-1 border-b pr-2","children":[["$","$L24",null,{"className":"w-full","viewportProps":{"className":"[&>div]:!table"},"children":["$","$L2c",null,{"className":"border-b-0","children":[["$","$L2d","chatRoom.js/.0",{"value":"chatRoom.js","children":"chatRoom.js"}],["$","$L2d","server.js/.1",{"value":"server.js","children":"server.js"}],["$","$L2d","client.js/.2",{"value":"client.js","children":"client.js"}]]}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5 text-foreground","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],[["$","$L2e","chatRoom.js/.0",{"value":"chatRoom.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$41"}}]}]}]]}]}],["$","$L2e","server.js/.1",{"value":"server.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$42"}}]}]}]]}]}],["$","$L2e","client.js/.2",{"value":"client.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$43"}}]}]}]]}]}]]]}]}],"\n",["$","$L21",null,{"level":3,"id":"redis-like-server","children":"Redis-Like Server"}],"\n",["$","p",null,{"children":"This example demonstrates a minimalistic Redis-like key-value store server with get, set, and delete operations."}],"\n",["$","div",null,{"className":"code-group group my-4 rounded-md border pt-2","data-code-group":true,"children":["$","$L2b",null,{"defaultValue":"redisWorker.js","children":[["$","div",null,{"className":"flex gap-1 border-b pr-2","children":[["$","$L24",null,{"className":"w-full","viewportProps":{"className":"[&>div]:!table"},"children":["$","$L2c",null,{"className":"border-b-0","children":[["$","$L2d","redisWorker.js/.0",{"value":"redisWorker.js","children":"redisWorker.js"}],["$","$L2d","server.js/.1",{"value":"server.js","children":"server.js"}],["$","$L2d","client.js/.2",{"value":"client.js","children":"client.js"}]]}]}],["$","$L22",null,{"trigger":["$","$L23",null,{"children":["$","button",null,{"className":"group group/button inline-flex items-center justify-center whitespace-nowrap rounded-md font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:z-10 relative aria-disabled:pointer-events-none aria-disabled:opacity-50 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-7 w-7 text-xs [&_svg]:size-3 gap-1.5 text-foreground","ref":"$undefined","disabled":"$undefined","children":[null,["$","svg",null,{"aria-hidden":"true","focusable":"false","data-prefix":"fas","data-icon":"copy","className":"svg-inline--fa fa-copy ","role":"img","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 448 512","style":{},"ref":"$undefined","children":["$","path",null,{"fill":"currentColor","d":"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z","style":{}}]}],null]}]}],"content":"Copy code"}]]}],[["$","$L2e","redisWorker.js/.0",{"value":"redisWorker.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$44"}}]}]}]]}]}],["$","$L2e","server.js/.1",{"value":"server.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$45"}}]}]}]]}]}],["$","$L2e","client.js/.2",{"value":"client.js","children":["$","div",null,{"className":"not-prose my-4 rounded-md border group-[.code-group]:my-0 group-[.code-group]:-mt-2 group-[.code-group]:border-none","data-code-group":true,"children":[null,["$","div",null,{"className":"bg-background text-wrap p-2 text-sm","children":["$","$L24",null,{"className":"w-full","children":["$","span",null,{"className":"not-prose code","dangerouslySetInnerHTML":{"__html":"$46"}}]}]}]]}]}]]]}]}],"\n",["$","$L21",null,{"level":2,"id":"more-thought-required","children":"More Thought Required"}],"\n",["$","$L21",null,{"level":3,"id":"data-migrations","children":"Data Migrations"}],"\n",["$","p",null,{"children":"WinterTC is great specification for stateless serverless since migrating providers is as simple as updating a DNS record."}],"\n",["$","p",null,{"children":["However, stateful serverless is significantly different since ",["$","strong",null,{"children":"this spec is effectively defining a database"}],", since ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}],"s have persistent storage."]}],"\n",["$","p",null,{"children":["If the whole point of defining a common specification for stateful serverless is to encourage companies to adopt new technologies, then they'll also need assurances on their ability to migrate between providers. For example, Postgres provides the ability to use ",["$","$La",null,{"href":"https://www.postgresql.org/docs/current/logical-replication.html","target":"_blank","children":"logical replication"}]," for live migrations and is used frequently."]}],"\n",["$","$L21",null,{"level":3,"id":"storage-2","children":"Storage"}],"\n",["$","p",null,{"children":"The storage is the most rough section of this spec. It probably justifies its own spec."}],"\n",["$","$L21",null,{"level":3,"id":"connection-interruptions","children":"Connection Interruptions"}],"\n",["$","p",null,{"children":[["$","code",null,{"dangerouslySetInnerHTML":{"__html":"SharedWorker"}}]," connections cannot be interrupted. Can ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," connections be interrupted? What happens if they are?"]}],"\n",["$","$L21",null,{"level":2,"id":"next-steps","children":"Next Steps"}],"\n",["$","p",null,{"children":["We ",["$","$La",null,{"href":"https://github.com/rivet-gg/proposal-stateful-serverless-api","children":"uploaded this proposal to GitHub"}]," for feedback and iteration. Once there's more momentum, I hope to move this out of the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"rivet-gg"}}]," organization in to an official W3C process."]}],"\n",["$","$L21",null,{"level":3,"id":"feedback-on-git-hub","children":"Feedback On GitHub"}],"\n",["$","p",null,{"children":["Please add feedback as a issue or pull request on the ",["$","$La",null,{"href":"https://github.com/rivet-gg/proposal-stateful-serverless-api","children":"proposal GitHub"}],"."]}],"\n",["$","$L21",null,{"level":3,"id":"reference-implementation","children":"Reference Implementation"}],"\n",["$","p",null,{"children":"Once a general specification is implemented, a reference specification is trivial to implement on any of the providers previously mentioned. A compatibility layer could be implemented on the existing work with Rivet drivers."}],"\n",["$","$L21",null,{"level":2,"id":"survey-help-shape-the-specification","children":"Survey: Help Shape the Specification"}],"\n",["$","p",null,{"children":["If you are either (a) a user of Durable Objects/Rivet actors or (b) want to aid in the direction, it'd be helpful to take the time to answer these questions as a ",["$","$La",null,{"href":"https://github.com/rivet-gg/proposal-stateful-serverless-api/issues","children":"GitHub issue"}]," on the proposal:"]}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Do we attempt to specify existing APIs or implement based on existing work by W3C?"}]," This spec aims to build on patterns already defined by W3C, however it might make sense to stick to better documenting overlap between existing providers (currently only Durable Objects & Rivet as far as I know). My understanding is WinterTC attempted to create a spec that matched existing APIs. I'd be happy to rewrite this spec based on the ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"fetch"}}]," API if the answer to this is ",["$","em",null,{"children":"yes"}],"."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"What are the most common hesitations for companies adopting stateful serverless?"}]," Is there something this spec can address?"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"What are the most common problems with stateful serverless that contributes to cognitive load?"}]," Does the simplicity of this spec help address that?"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"What reference design patterns should we be designing for?"}]," The examples attached attempt to provide a very basic overview of common patterns on Durable Objects, but does not cover use cases like worker-worker communication."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"How should storage be represented?"}]," This spec proposes using a simple KV. This storage mechanism might be too restrictive, or we might not want to write a spec for storage altogether and keep ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," very simple. It may make sense to leverage an existing storage spec or write a new separate storage spec that is combined with this."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Should this be broader than web technologies?"}]," This spec makes the assumption it's part of W3C and leverages web technologies. However, there are a few container platforms that do not use web technologies which might fall under this scope."]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Should this spec care about regions?"}]," ",["$","code",null,{"dangerouslySetInnerHTML":{"__html":"ServerlessWorker"}}]," shine when they run at the edge. Should they have a default for configuring locations, similar to Rivet and Cloudflare?"]}],"\n"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":["Thanks to ",["$","$La",null,{"href":"https://x.com/LambrosPetrou","children":"LambrosPetrou"}],", ",["$","$La",null,{"href":"https://x.com/firtozb","children":"firtozb"}],", ",["$","$La",null,{"href":"https://x.com/uripont_","children":"uripont_"}],", and ",["$","$La",null,{"href":"https://x.com/p_mbanugo","children":"p_mbanugo"}]," for feedback on the initial document."]}]}]],["$","$L47",null,{"title":"Considering A W3C Standard For Stateful Serverless"}]]}],["$","aside",null,{"className":"order-2 min-w-0 max-w-xs flex-1 lg:order-3","children":["$","$L48",null,{"tableOfContents":[{"title":"What Is Stateful Serverless?","id":"what-is-stateful-serverless","children":[{"title":"Stateless Serverless (Functions) vs Stateful Serverless (Workers)","id":"stateless-serverless-functions-vs-stateful-serverless-workers","children":[]},{"title":"Primary Use Cases","id":"primary-use-cases","children":[]},{"title":"Scope Of This Proposal","id":"scope-of-this-proposal","children":[]}]},{"title":"Why Should I Care?","id":"why-should-i-care","children":[]},{"title":"Why Build A Web Standard?","id":"why-build-a-web-standard","children":[{"title":"Customers Wary Of Vendor-Lock","id":"customers-wary-of-vendor-lock","children":[]},{"title":"Incentivize More Providers","id":"incentivize-more-providers","children":[]}]},{"title":"Today's Stateful Serverless Implementations","id":"todays-stateful-serverless-implementations","children":[{"title":"Cloudflare Durable Objects: The Most Popular Option","id":"cloudflare-durable-objects-the-most-popular-option","children":[]},{"title":"Cloudflare Agents Framework: Moving Beyond Durable Objects","id":"cloudflare-agents-framework-moving-beyond-durable-objects","children":[]},{"title":"Rivet: Open-Source Serverless Infrastructure","id":"rivet-open-source-serverless-infrastructure","children":[]},{"title":"RivetKit Framework: Stateful Serverless On Any Cloud","id":"rivet-kit-framework-stateful-serverless-on-any-cloud","children":[]},{"title":"Other Actor Runtimes: The Precursor To Stateful Serverless","id":"other-actor-runtimes-the-precursor-to-stateful-serverless","children":[]}]},{"title":"Specification Goals","id":"specification-goals","children":[{"title":"Classes vs Functions","id":"classes-vs-functions","children":[]},{"title":"Alternative #1: Fetch-Based Communication","id":"alternative-1-fetch-based-communication","children":[]},{"title":"Alternative #2: A CGI-Like Standard","id":"alternative-2-a-cgi-like-standard","children":[]}]},{"title":"Drawing Inspiration From SharedWorker","id":"drawing-inspiration-from-shared-worker","children":[]},{"title":"Introducing ServerlessWorker","id":"introducing-serverless-worker","children":[{"title":"Creating, Initializing, & Addressing ServerlessWorkers","id":"creating-initializing-and-addressing-serverless-workers","children":[]},{"title":"Terminating ServerlessWorkers","id":"terminating-serverless-workers","children":[]},{"title":"Connections & Messages","id":"connections-and-messages","children":[]},{"title":"Storage","id":"storage","children":[]},{"title":"Scheduling","id":"scheduling","children":[]},{"title":"Sleeping & Upgrading & Host Migrations","id":"sleeping-and-upgrading-and-host-migrations","children":[]},{"title":"Handling Backpressure","id":"handling-backpressure","children":[]},{"title":"Security Model","id":"security-model","children":[]},{"title":"Out Of Scope","id":"out-of-scope","children":[]}]},{"title":"Full Examples","id":"full-examples","children":[{"title":"Rate Limiter","id":"rate-limiter","children":[]},{"title":"Pub/Sub Server","id":"pub-sub-server","children":[]},{"title":"Simple Chat Room","id":"simple-chat-room","children":[]},{"title":"Redis-Like Server","id":"redis-like-server","children":[]}]},{"title":"More Thought Required","id":"more-thought-required","children":[{"title":"Data Migrations","id":"data-migrations","children":[]},{"title":"Storage","id":"storage-2","children":[]},{"title":"Connection Interruptions","id":"connection-interruptions","children":[]}]},{"title":"Next Steps","id":"next-steps","children":[{"title":"Feedback On GitHub","id":"feedback-on-git-hub","children":[]},{"title":"Reference Implementation","id":"reference-implementation","children":[]}]},{"title":"Survey: Help Shape the Specification","id":"survey-help-shape-the-specification","children":[]}]}]}]]}]]}],["$","$L49",null,{"className":"mx-auto w-full mb-8 xl:max-w-[1000px]"}]]
17:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
12:null
1a:{"metadata":[["$","title","0",{"children":"Considering A W3C Standard For Stateful Serverless"}],["$","meta","1",{"name":"description","content":"We're Rivet, a new open-source, self-hostable serverless platform with a focus on stateful serverless. If you want to support our mission of building a production-ready and self-hostable serverless runtime, give us a star on GitHub."}],["$","link","2",{"rel":"author","href":"https://x.com/NathanFlurry/"}],["$","meta","3",{"name":"author","content":"Nathan Flurry"}],["$","meta","4",{"property":"og:title","content":"Considering A W3C Standard For Stateful Serverless"}],["$","meta","5",{"property":"og:description","content":"We're Rivet, a new open-source, self-hostable serverless platform with a focus on stateful serverless. If you want to support our mission of building a production-ready and self-hostable serverless runtime, give us a star on GitHub."}],["$","meta","6",{"property":"og:image","content":"http://localhost:3000/_next/static/media/image.00c62794.png"}],["$","meta","7",{"property":"og:image:width","content":"2048"}],["$","meta","8",{"property":"og:image:height","content":"1024"}],["$","meta","9",{"property":"og:type","content":"article"}],["$","meta","10",{"property":"article:published_time","content":"2025-03-23T00:00:00.000Z"}],["$","meta","11",{"property":"article:author","content":"Nathan Flurry"}],["$","meta","12",{"property":"article:section","content":"Technical"}],["$","meta","13",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","14",{"name":"twitter:site","content":"@rivetgg"}],["$","meta","15",{"name":"twitter:title","content":"Considering A W3C Standard For Stateful Serverless"}],["$","meta","16",{"name":"twitter:description","content":"We're Rivet, a new open-source, self-hostable serverless platform with a focus on stateful serverless. If you want to support our mission of building a production-ready and self-hostable serverless runtime, give us a star on GitHub."}],["$","meta","17",{"name":"twitter:image","content":"http://localhost:3000/_next/static/media/image.00c62794.png"}],["$","meta","18",{"name":"twitter:image:width","content":"2048"}],["$","meta","19",{"name":"twitter:image:height","content":"1024"}]],"error":null,"digest":"$undefined"}
15:{"metadata":"$1a:metadata","error":null,"digest":"$undefined"}
1f:["$","ul",null,{"className":"text-muted-foreground hidden list-disc pl-5 text-sm lg:block","children":[["$","li","2025-07-01-introducing-rivetkit-backend-libraries-that-replace-saas",{"className":"py-1","children":["$","$La",null,{"href":"/changelog/2025-07-01-introducing-rivetkit-backend-libraries-that-replace-saas","children":"Introducing RivetKit: Backend Libraries That Replace SaaS"}]}],["$","li","2025-06-24-cloudflare-containers-vs-rivet-containers-vs-fly-machines",{"className":"py-1","children":["$","$La",null,{"href":"/blog/2025-06-24-cloudflare-containers-vs-rivet-containers-vs-fly-machines","children":"Container Platform Comparison: Cloudflare Containers vs Rivet Containers vs Fly Machines"}]}],["$","li","2025-06-10-rivet-functions-launch",{"className":"py-1","children":["$","$La",null,{"href":"/changelog/2025-06-10-rivet-functions-launch","children":"Rivet Functions Launch"}]}]]}]
